<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Èí¢Áê¥Âùó - Ëá™Âà∂Ê≠åÊõ≤</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            height: 100%;
            overflow: hidden;
            touch-action: manipulation;
            background: #000;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            -webkit-user-select: none;
            user-select: none;
        }

        .splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            background: #000;
        }

        .splash-background {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('Â∞ÅÈù¢.jpg') center/cover no-repeat;
            opacity: 0.7;
            background-attachment: fixed;
            background-position: center center;
            background-size: cover;
            background-repeat: no-repeat;
        }

        .splash-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(180deg, rgba(0, 0, 0, 0.3) 0%, rgba(0, 0, 0, 0.7) 100%);
        }

        .splash-content {
            position: relative;
            z-index: 1;
            text-align: center;
            padding: 20px;
        }

        .splash-title {
            color: #fff;
            font-size: 3.5rem;
            font-family: "Microsoft YaHei", "PingFang SC", sans-serif;
            font-weight: 300;
            text-shadow: none;
            margin-bottom: 80px;
            letter-spacing: 0.5em;
            position: relative;
            display: inline-block;
        }

        .splash-title span {
            display: inline-block;
            animation: fadeInUp 0.8s ease-out forwards;
            opacity: 0;
            transform: translateY(20px);
        }

        .splash-title span:nth-child(1) { animation-delay: 0.1s; }
        .splash-title span:nth-child(2) { animation-delay: 0.2s; }
        .splash-title span:nth-child(3) { animation-delay: 0.3s; }
        .splash-title span:nth-child(4) { animation-delay: 0.4s; }
        .splash-title span:nth-child(5) { animation-delay: 0.5s; }

        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ÊªëÂä®Ëß£ÈîÅ */
        .slide-unlock {
            position: relative;
            width: 280px;
            height: 60px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 30px;
            overflow: hidden;
            cursor: pointer;
            box-shadow: 
                inset 0 2px 5px rgba(0,0,0,0.2),
                0 2px 10px rgba(0,0,0,0.2);
        }

        .slide-unlock-track {
            position: absolute;
            top: 5px;
            left: 5px;
            right: 5px;
            bottom: 5px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .slide-unlock-text {
            color: rgba(255, 255, 255, 0.7);
            font-size: 1rem;
            font-family: "Microsoft YaHei", "PingFang SC", sans-serif;
            letter-spacing: 0.2em;
            transition: opacity 0.3s;
        }

        .slide-unlock-text.sliding {
            opacity: 0;
        }

        .slide-unlock-thumb {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 54px;
            height: 54px;
            background: linear-gradient(180deg, #fff 0%, #e8e8e8 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: 
                0 3px 0 #999,
                0 3px 5px rgba(0,0,0,0.3);
            transition: transform 0.1s;
            z-index: 2;
        }

        .slide-unlock-thumb::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 8px;
            right: 8px;
            height: 3px;
            background: rgba(0,0,0,0.1);
            border-radius: 50%;
        }

        .slide-unlock-thumb.pressed {
            transform: scale(0.95);
            box-shadow: 
                0 1px 0 #999,
                0 1px 3px rgba(0,0,0,0.3);
        }

        .slide-unlock-success {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(180deg, #4CAF50, #45a049);
            border-radius: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.3s ease-out;
        }

        .slide-unlock-success.show {
            transform: scaleX(1);
        }

        .slide-unlock-success span {
            color: #fff;
            font-size: 1.1rem;
            font-weight: bold;
            letter-spacing: 0.3em;
        }

        @media (max-width: 480px) {
            .slide-unlock {
                width: 240px;
                height: 55px;
            }

            .slide-unlock-thumb {
                width: 49px;
                height: 49px;
            }
        }

        .splash-btn {
            padding: 20px 60px;
            background: linear-gradient(180deg, #fff 0%, #e8e8e8 50%, #d0d0d0 100%);
            color: #1a1a1a;
            border: none;
            border-radius: 10px 10px 8px 8px;
            font-size: 1.1rem;
            font-family: "Microsoft YaHei", "PingFang SC", sans-serif;
            font-weight: 600;
            cursor: pointer;
            letter-spacing: 0.4em;
            position: relative;
            box-shadow: 
                0 8px 0 #999,
                0 8px 10px rgba(0,0,0,0.3),
                0 15px 20px rgba(0,0,0,0.2),
                inset 0 1px 0 rgba(255,255,255,0.8);
            transition: all 0.1s ease;
            text-transform: uppercase;
        }

        .splash-btn::before {
            content: '';
            position: absolute;
            top: 3px;
            left: 10px;
            right: 10px;
            height: 4px;
            background: linear-gradient(180deg, rgba(0,0,0,0.1), transparent);
            border-radius: 50%;
        }

        .splash-btn:hover {
            background: linear-gradient(180deg, #fff 0%, #f5f5f5 50%, #e8e8e8 100%);
            transform: translateY(-2px);
            box-shadow: 
                0 10px 0 #999,
                0 10px 15px rgba(0,0,0,0.3),
                0 20px 25px rgba(0,0,0,0.2),
                inset 0 1px 0 rgba(255,255,255,0.8);
        }

        .splash-btn:active {
            transform: translateY(6px);
            box-shadow: 
                0 2px 0 #999,
                0 2px 5px rgba(0,0,0,0.3),
                0 5px 10px rgba(0,0,0,0.2),
                inset 0 1px 0 rgba(255,255,255,0.8);
        }

        .splash-btn:active::before {
            opacity: 0;
        }

        .splash-music-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 102;
        }

        .splash-music-btn, .music-btn {
            padding: 10px 16px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 20px;
            color: #fff;
            font-size: 0.85rem;
            cursor: pointer;
            font-weight: bold;
        }

        /* Ê®™Â±èÊèêÁ§∫ */
        .rotate-hint {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(180deg, #0c1445 0%, #1a1a4e 50%, #2d1b4e 100%);
            z-index: 9999;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .rotate-hint.show {
            display: flex;
        }

        .rotate-icon {
            font-size: 4rem;
            animation: rotateAnim 1.5s ease-in-out infinite;
            margin-bottom: 20px;
        }

        @keyframes rotateAnim {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-30deg); }
            75% { transform: rotate(30deg); }
        }

        .rotate-text {
            color: #fff;
            font-size: 1.5rem;
            text-align: center;
            line-height: 1.6;
        }

        .rotate-subtext {
            color: rgba(255, 255, 255, 0.6);
            font-size: 1rem;
            margin-top: 10px;
        }

        .rotate-dismiss-btn {
            margin-top: 30px;
            padding: 15px 40px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-radius: 25px;
            color: #fff;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .rotate-dismiss-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        @media (max-width: 768px) and (orientation: portrait) {
            .rotate-hint {
                display: flex;
            }
        }

        @media (max-width: 480px) {
            .splash-title {
                font-size: 2.2rem;
                letter-spacing: 0.3em;
                margin-bottom: 50px;
            }

            .splash-btn {
                padding: 16px 40px;
                font-size: 0.9rem;
                box-shadow: 
                    0 5px 0 #999,
                    0 5px 8px rgba(0,0,0,0.3),
                    0 10px 15px rgba(0,0,0,0.2),
                    inset 0 1px 0 rgba(255,255,255,0.8);
            }

            .splash-btn:active {
                transform: translateY(4px);
                box-shadow: 
                    0 1px 0 #999,
                    0 1px 3px rgba(0,0,0,0.3),
                    0 3px 5px rgba(0,0,0,0.2),
                    inset 0 1px 0 rgba(255,255,255,0.8);
            }

            .splash-btn:hover {
                transform: translateY(-1px);
                box-shadow: 
                    0 6px 0 #999,
                    0 6px 10px rgba(0,0,0,0.3),
                    0 12px 18px rgba(0,0,0,0.2),
                    inset 0 1px 0 rgba(255,255,255,0.8);
            }
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.8; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.05); }
        }

        @keyframes btnPulse {
            0%, 100% { transform: scale(1); box-shadow: 0 6px 30px rgba(233, 69, 96, 0.5); }
            50% { transform: scale(1.05); box-shadow: 0 8px 40px rgba(233, 69, 96, 0.7); }
        }

        .header {
            width: 100%;
            padding: 15px;
            text-align: center;
            background: linear-gradient(180deg, rgba(233, 69, 96, 0.3) 0%, transparent 100%);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #fff;
            font-size: 1.3rem;
            text-shadow: 0 0 20px #e94560;
        }

        .header-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #e94560, #c73e54);
            color: #fff;
            border: none;
            border-radius: 25px;
            font-size: 0.95rem;
            cursor: pointer;
            font-weight: bold;
        }

        .screen {
            display: none;
            height: calc(100vh - 60px);
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            background: linear-gradient(180deg, #0c1445 0%, #1a1a4e 50%, #2d1b4e 100%);
        }

        .screen.active {
            display: block;
        }

        /* ÊâÄÊúâÂ±èÂπïÂßãÁªàÊ®™Â±èÊòæÁ§∫ */
        @media (max-width: 900px) {
            .screen.active {
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                overflow: hidden;
                z-index: 5;
            }
            
            /* Á´ñÂ±èÊó∂ÊóãËΩ¨90Â∫¶ */
            @media (orientation: portrait) {
                .screen.active {
                    transform: rotate(90deg);
                    transform-origin: center center;
                }
            }
        }
        
        /* ÂÆâÂçìÊâãÊú∫Â∞∫ÂØ∏‰ºòÂåñ */
        @media (max-width: 480px) {
            .screen.active {
                transform: rotate(90deg) scale(0.9);
                transform-origin: center center;
            }
        }
        
        @media (max-width: 360px) {
            .screen.active {
                transform: rotate(90deg) scale(0.8);
                transform-origin: center center;
            }
        }

        .lobby-container {
            padding: 15px;
            max-width: 500px;
            margin: 0 auto;
        }

        .song-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .song-card:active {
            transform: scale(0.98);
            background: rgba(255, 255, 255, 0.15);
        }

        .song-card .title {
            color: #fff;
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .song-card .author {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.8rem;
            margin-bottom: 8px;
        }

        .song-card .stats {
            display: flex;
            gap: 12px;
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.75rem;
        }

        .editor-container {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .editor-header {
            padding: 10px 15px;
            background: rgba(0, 0, 0, 0.4);
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }
        
        .duration-control {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #fff;
            font-size: 0.9rem;
            flex-wrap: wrap;
        }

        .duration-buttons {
            display: flex;
            gap: 4px;
        }

        #customDuration {
            width: 80px;
            padding: 6px 8px;
            border: none;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.15);
            color: #fff;
            font-size: 0.85rem;
        }

        #customDuration::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
        
        .duration-btn {
            padding: 6px 10px;
            border: none;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
        }
        
        .duration-btn.active {
            background: #e94560;
            color: #fff;
        }

        .octave-control {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #fff;
            font-size: 0.9rem;
        }

        #octaveSelect {
            padding: 6px 8px;
            border: none;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.15);
            color: #fff;
            font-size: 0.85rem;
            cursor: pointer;
        }

        #octaveSelect option {
            background: #1a1a4e;
            color: #fff;
        }

        .editor-header input {
            padding: 10px 14px;
            border: none;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.15);
            color: #fff;
            font-size: 0.95rem;
        }

        .editor-header input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .editor-header input[type="text"] {
            flex: 1;
            min-width: 100px;
        }

        .speed-control {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #fff;
            font-size: 0.9rem;
        }

        .speed-control input {
            width: 60px;
            padding: 8px !important;
        }

        .editor-btn {
            padding: 10px 16px;
            border: none;
            border-radius: 10px;
            font-size: 0.9rem;
            cursor: pointer;
            font-weight: bold;
        }

        .editor-btn.primary {
            background: linear-gradient(135deg, #e94560, #c73e54);
            color: #fff;
        }

        .editor-btn.secondary {
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
        }

        .editor-area {
            flex: 1;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .editor-tracks {
            display: flex;
            flex: 1;
            position: relative;
            min-height: 400px;
            overflow-y: auto;
            max-height: 600px;
        }

        .editor-track {
            flex: 1;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            cursor: pointer;
            min-height: 400px;
        }

        .editor-track:active {
            background: rgba(233, 69, 96, 0.2);
        }

        .editor-note {
            position: absolute;
            width: 90%;
            left: 5%;
            height: 45px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-weight: bold;
            font-size: 0.85rem;
            cursor: pointer;
            z-index: 2;
        }

        .editor-note.track0 { background: linear-gradient(135deg, #ff6b6b, #ee5a5a); }
        .editor-note.track1 { background: linear-gradient(135deg, #4ecdc4, #44a8a0); }
        .editor-note.track2 { background: linear-gradient(135deg, #ffe66d, #ffd93d); }
        .editor-note.track3 { background: linear-gradient(135deg, #a29bfe, #8c7ae6); }
        .editor-note.track4 { background: linear-gradient(135deg, #fd79a8, #e84393); }
        .editor-note.track5 { background: linear-gradient(135deg, #74b9ff, #0984e3); }
        .editor-note.track6 { background: linear-gradient(135deg, #55efc4, #00b894); }

        .editor-keys {
            display: flex;
            height: 80px;
            flex-shrink: 0;
        }

        .editor-key {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #fff;
            cursor: pointer;
            border: none;
            outline: none;
        }

        .editor-key span {
            font-size: 1.5rem;
        }

        .editor-key small {
            font-size: 0.7rem;
            opacity: 0.9;
        }

        .editor-key.track0 { background: linear-gradient(180deg, #ff6b6b, #c0392b); }
        .editor-key.track1 { background: linear-gradient(180deg, #4ecdc4, #16a085); }
        .editor-key.track2 { background: linear-gradient(180deg, #ffe66d, #f39c12); }
        .editor-key.track3 { background: linear-gradient(180deg, #a29bfe, #6c5ce7); }
        .editor-key.track4 { background: linear-gradient(180deg, #fd79a8, #d63384); }
        .editor-key.track5 { background: linear-gradient(180deg, #74b9ff, #0984e3); }
        .editor-key.track6 { background: linear-gradient(180deg, #55efc4, #00b894); }

        .playback-controls {
            padding: 10px;
            background: rgba(0, 0, 0, 0.4);
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .game-container {
            position: relative;
            width: 100%;
            height: 100%;
            margin: 0 auto;
            overflow: hidden;
        }

        .track-container {
            display: flex;
            height: calc(100% - 80px);
            position: relative;
        }

        .track {
            flex: 1;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            cursor: pointer;
        }

        .track:last-child {
            border-right: none;
        }

        .track:active {
            background: rgba(233, 69, 96, 0.15);
        }

        .key-line {
            position: absolute;
            bottom: 80px;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, #00d9ff, #00ff88);
            z-index: 2;
            box-shadow: 0 0 15px #00d9ff;
        }

        .note {
            position: absolute;
            width: 90%;
            left: 5%;
            height: 55px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #fff;
            z-index: 1;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
        }



        .note.hit {
            animation: noteHit 0.3s ease-out forwards;
        }

        @keyframes noteHit {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(1.3); opacity: 0; }
        }

        .note.track0 { background: linear-gradient(135deg, #ff6b6b, #ee5a5a); }
        .note.track1 { background: linear-gradient(135deg, #4ecdc4, #44a8a0); }
        .note.track2 { background: linear-gradient(135deg, #ffe66d, #ffd93d); }
        .note.track3 { background: linear-gradient(135deg, #a29bfe, #8c7ae6); }
        .note.track4 { background: linear-gradient(135deg, #fd79a8, #e84393); }
        .note.track5 { background: linear-gradient(135deg, #74b9ff, #0984e3); }
        .note.track6 { background: linear-gradient(135deg, #55efc4, #00b894); }

        .keys {
            display: flex;
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 80px;
            z-index: 3;
        }

        .key {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #fff;
            cursor: pointer;
            border: none;
            outline: none;
        }

        .key span {
            font-size: 1.6rem;
        }

        .key small {
            font-size: 0.65rem;
            opacity: 0.9;
        }

        .key:active, .key.pressed {
            filter: brightness(1.3);
        }

        .key.track0 { background: linear-gradient(180deg, #ff6b6b, #c0392b); }
        .key.track1 { background: linear-gradient(180deg, #4ecdc4, #16a085); }
        .key.track2 { background: linear-gradient(180deg, #ffe66d, #f39c12); }
        .key.track3 { background: linear-gradient(180deg, #a29bfe, #6c5ce7); }
        .key.track4 { background: linear-gradient(180deg, #fd79a8, #d63384); }
        .key.track5 { background: linear-gradient(180deg, #74b9ff, #0984e3); }
        .key.track6 { background: linear-gradient(180deg, #55efc4, #00b894); }

        .score-display {
            position: absolute;
            top: 12px;
            left: 12px;
            color: #fff;
            font-size: 0.95rem;
            background: rgba(0, 0, 0, 0.5);
            padding: 8px 16px;
            border-radius: 20px;
            z-index: 10;
        }

        .combo-display {
            position: absolute;
            top: 48px;
            left: 12px;
            color: #ffe66d;
            font-size: 0.85rem;
            background: rgba(0, 0, 0, 0.5);
            padding: 6px 14px;
            border-radius: 15px;
            z-index: 10;
        }

        .start-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 20;
        }

        .start-btn {
            padding: 20px 60px;
            font-size: 1.3rem;
            background: linear-gradient(135deg, #e94560, #c73e54);
            color: #fff;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 5px 30px rgba(233, 69, 96, 0.5);
            animation: btnPulse 2s infinite;
            font-weight: bold;
        }

        .title-text {
            color: #fff;
            font-size: 1.8rem;
            margin-bottom: 30px;
            text-shadow: 0 0 30px #e94560;
            text-align: center;
        }

        .message {
            position: absolute;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #ffe66d;
            font-size: 2rem;
            font-weight: bold;
            text-shadow: 0 0 30px #ffe66d;
            opacity: 0;
            pointer-events: none;
            z-index: 15;
        }

        .message.show {
            animation: messageShow 0.6s ease-out;
        }

        @keyframes messageShow {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.3); }
            30% { opacity: 1; transform: translate(-50%, -50%) scale(1.3); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(1); }
        }

        .final-score {
            color: #fff;
            font-size: 1.2rem;
            margin-top: 20px;
        }

        .final-score span {
            color: #ffe66d;
            font-size: 1.5rem;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            color: #fff;
        }

        .empty-state {
            text-align: center;
            color: rgba(255, 255, 255, 0.5);
            padding: 40px;
            font-size: 1rem;
        }

        .toast {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            color: #fff;
            padding: 15px 30px;
            border-radius: 10px;
            z-index: 100;
            display: none;
            font-size: 1rem;
        }

        .toast.show {
            display: block;
            animation: toastShow 0.3s ease-out;
        }

        @keyframes toastShow {
            from { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }

        .confirm-dialog {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }

        .confirm-dialog.show {
            display: flex;
        }

        .confirm-content {
            background: #1a1a4e;
            padding: 25px;
            border-radius: 20px;
            text-align: center;
            max-width: 300px;
            width: 80%;
        }

        .confirm-content h3 {
            color: #fff;
            margin-bottom: 20px;
            font-size: 1.1rem;
        }

        .confirm-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .confirm-btn {
            padding: 10px 25px;
            border: none;
            border-radius: 20px;
            font-size: 1rem;
            cursor: pointer;
            font-weight: bold;
        }

        .confirm-btn.cancel {
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
        }

        .confirm-btn.confirm {
            background: #e94560;
            color: #fff;
        }

        .editor-empty-tip {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: rgba(255, 255, 255, 0.25);
            font-size: 1.1rem;
            text-align: center;
            pointer-events: none;
        }

        .game-back-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            padding: 10px 18px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 20px;
            color: #fff;
            font-size: 0.9rem;
            cursor: pointer;
            z-index: 25;
        }

        .volume-control {
            position: absolute;
            top: 12px;
            right: 100px;
            z-index: 25;
        }

        .volume-btn {
            padding: 10px 12px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 20px;
            color: #fff;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .volume-slider {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 5px;
            width: 100px;
            background: rgba(0, 0, 0, 0.8);
            padding: 10px;
            border-radius: 10px;
            display: none;
            z-index: 30;
        }

        .volume-slider.show {
            display: block;
        }

        .volume-slider input {
            width: 100%;
            margin: 5px 0;
        }

        .volume-level {
            color: #fff;
            font-size: 0.8rem;
            text-align: center;
            margin-top: 5px;
        }

        @media (max-width: 480px) {
            .splash-title {
                font-size: 2rem;
                margin-bottom: 30px;
            }
            
            .splash-btn {
                padding: 18px 45px;
                font-size: 1.3rem;
            }
            
            .header h1 {
                font-size: 1.1rem;
            }
            
            .header-btn {
                padding: 8px 16px;
                font-size: 0.85rem;
            }
            
            .song-card {
                padding: 12px;
                margin-bottom: 10px;
            }
            
            .song-card .title {
                font-size: 1rem;
            }
            
            .start-btn {
                padding: 18px 50px;
                font-size: 1.2rem;
            }
            
            .editor-header {
                padding: 8px 12px;
            }
            
            .editor-header input {
                padding: 8px 12px;
                font-size: 0.85rem;
            }
            
            .speed-control input {
                width: 50px;
                padding: 6px !important;
            }
            
            .editor-btn {
                padding: 8px 14px;
                font-size: 0.85rem;
            }
            
            .key span {
                font-size: 1.4rem;
            }
            
            .key small {
                font-size: 0.6rem;
            }
            
            .score-display,
            .combo-display {
                font-size: 0.85rem;
                padding: 6px 12px;
            }
        }
        
        @media (max-width: 360px) {
            .splash-title {
                font-size: 1.8rem;
                margin-bottom: 25px;
            }
            
            .splash-btn {
                padding: 16px 40px;
                font-size: 1.2rem;
            }
            
            .header h1 {
                font-size: 1rem;
            }
            
            .header-btn {
                padding: 6px 12px;
                font-size: 0.8rem;
            }
            
            .start-btn {
                padding: 16px 40px;
                font-size: 1.1rem;
            }
        }

        /* ÁôªÂΩïÊ≥®ÂÜåÁïåÈù¢Ê†∑Âºè */
        .auth-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(180deg, #0c1445 0%, #1a1a4e 50%, #2d1b4e 100%);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 101;
        }

        .auth-screen.active {
            display: flex;
        }

        .auth-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .auth-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .auth-header h2 {
            color: #fff;
            font-size: 1.8rem;
            margin: 0;
            text-shadow: 0 0 20px #e94560;
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .form-group label {
            color: #fff;
            font-size: 0.95rem;
            font-weight: bold;
        }

        .form-group input {
            padding: 12px 16px;
            border: none;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.15);
            color: #fff;
            font-size: 1rem;
        }

        .form-group input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .auth-btn {
            padding: 14px;
            background: linear-gradient(135deg, #e94560, #c73e54);
            color: #fff;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .auth-btn:active {
            transform: scale(0.98);
        }

        .auth-toggle {
            text-align: center;
            margin-top: 10px;
        }

        .auth-toggle span {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9rem;
            cursor: pointer;
            transition: color 0.3s;
        }

        .auth-toggle span:hover {
            color: #fff;
        }

        /* ÊéíË°åÊ¶úÊ†∑Âºè */
        .leaderboard-dialog {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .leaderboard-dialog.show {
            display: flex;
        }

        .leaderboard-content {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .leaderboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .leaderboard-header h2 {
            color: #fff;
            font-size: 1.5rem;
            margin: 0;
        }

        .leaderboard-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            color: #fff;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .leaderboard-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .admin-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .admin-song-item {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid #ffc107;
        }

        .admin-song-info {
            flex: 1;
        }

        .admin-song-title {
            color: #fff;
            font-size: 1rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .admin-song-author {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.85rem;
        }

        .admin-song-actions {
            display: flex;
            gap: 10px;
        }

        .admin-approve-btn {
            padding: 8px 16px;
            background: #4CAF50;
            border: none;
            border-radius: 6px;
            color: #fff;
            cursor: pointer;
            font-weight: bold;
        }

        .admin-reject-btn {
            padding: 8px 16px;
            background: #f44336;
            border: none;
            border-radius: 6px;
            color: #fff;
            cursor: pointer;
            font-weight: bold;
        }

        .leaderboard-item {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid #e94560;
        }

        .leaderboard-item.top {
            border-left-color: #ffe66d;
            background: rgba(255, 230, 109, 0.1);
        }

        .leaderboard-rank {
            font-size: 1.2rem;
            font-weight: bold;
            color: #fff;
            min-width: 30px;
        }

        .leaderboard-id {
            flex: 1;
            color: #fff;
            font-size: 1rem;
        }

        .leaderboard-score {
            color: #ffe66d;
            font-size: 1.1rem;
            font-weight: bold;
        }

        /* ÊêúÁ¥¢ÂäüËÉΩÊ†∑Âºè */
        .search-container {
            padding: 15px;
            max-width: 500px;
            margin: 0 auto;
            position: sticky;
            top: 0;
            background: rgba(12, 20, 69, 0.95);
            backdrop-filter: blur(10px);
            z-index: 10;
        }

        .search-box {
            display: flex;
            gap: 10px;
        }

        .search-input {
            flex: 1;
            padding: 12px 16px;
            border: none;
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.15);
            color: #fff;
            font-size: 1rem;
        }

        .search-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .search-btn {
            padding: 12px 20px;
            background: linear-gradient(135deg, #e94560, #c73e54);
            color: #fff;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            cursor: pointer;
            font-weight: bold;
        }

        /* Ê≠åÊõ≤Âç°ÁâáÂ¢ûÂº∫Ê†∑Âºè */
        .song-card {
            position: relative;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .song-card:active {
            transform: scale(0.98);
            background: rgba(255, 255, 255, 0.15);
        }

        .song-card .title {
            color: #fff;
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .song-card .author {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.8rem;
            margin-bottom: 8px;
        }

        .song-card .stats {
            display: flex;
            gap: 12px;
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.75rem;
        }

        .song-card .like-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            color: #fff;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .song-card .like-btn.liked {
            background: #e94560;
            color: #fff;
        }

        .song-card .user-score {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.8rem;
        }

        /* Â§¥ÈÉ®Â¢ûÂº∫Ê†∑Âºè */
        .header {
            width: 100%;
            padding: 15px;
            text-align: center;
            background: linear-gradient(180deg, rgba(233, 69, 96, 0.3) 0%, transparent 100%);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 20;
        }

        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .user-info {
            color: #fff;
            font-size: 0.9rem;
            margin-right: 10px;
        }

        .leaderboard-btn {
            padding: 10px 18px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 20px;
            color: #fff;
            font-size: 0.9rem;
            cursor: pointer;
            font-weight: bold;
        }

        .music-btn {
            padding: 10px 18px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 20px;
            color: #fff;
            font-size: 0.9rem;
            cursor: pointer;
            font-weight: bold;
        }

        .music-btn.muted {
            background: rgba(255, 255, 255, 0.1);
            opacity: 0.7;
        }

        .sfx-btn {
            padding: 10px 18px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 20px;
            color: #fff;
            font-size: 0.9rem;
            cursor: pointer;
            font-weight: bold;
        }

        .sfx-btn.muted {
            background: rgba(255, 255, 255, 0.1);
            opacity: 0.7;
        }

        .admin-btn {
            padding: 10px 18px;
            background: rgba(255, 193, 7, 0.4);
            border: none;
            border-radius: 20px;
            color: #fff;
            font-size: 0.9rem;
            cursor: pointer;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <!-- ÁßªÈô§Ê®™Â±èÊèêÁ§∫ÔºåÁõ¥Êé•ËøõÂÖ•Ê∏∏Êàè -->

    <div class="splash-screen" id="splashScreen">
        <div class="splash-background"></div>
        <div class="splash-overlay"></div>
        <div class="splash-content">
            <div class="splash-title">
                <span>Èí¢</span><span>Áê¥</span><span>Âùó</span><span>Ëá™</span><span>Âä©</span>
            </div>
            <div class="slide-unlock" id="slideUnlock">
                <div class="slide-unlock-track">
                    <span class="slide-unlock-text" id="slideText">ÊªëÂä®ÂºÄÂßã</span>
                </div>
                <div class="slide-unlock-thumb" id="slideThumb">‚Üí</div>
                <div class="slide-unlock-success" id="slideSuccess">
                    <span>ÂºÄÂßãÊ∏∏Êàè</span>
                </div>
            </div>
        </div>
        <button class="music-btn splash-music-btn" id="splashMusicBtn">üéµ Èü≥‰πê</button>
    </div>

    <div class="auth-screen" id="authScreen">
        <button class="music-btn splash-music-btn" id="authMusicBtn">üéµ Èü≥‰πê</button>
        <div class="auth-container">
            <div class="auth-header">
                <h2 id="authTitle">ÁôªÂΩï</h2>
            </div>
            <div class="auth-form">
                <div class="form-group">
                    <label for="authId">ID</label>
                    <input type="text" id="authId" placeholder="ËØ∑ËæìÂÖ•ID">
                </div>
                <div class="form-group">
                    <label for="authPassword">ÂØÜÁ†Å</label>
                    <input type="password" id="authPassword" placeholder="ËØ∑ËæìÂÖ•ÂØÜÁ†Å">
                </div>
                <button class="auth-btn" id="authSubmitBtn">ÁôªÂΩï</button>
                <div class="auth-toggle">
                    <span id="authToggleText">Ê≤°ÊúâË¥¶Âè∑ÔºüÁÇπÂáªÊ≥®ÂÜå</span>
                </div>
            </div>
        </div>
    </div>

    <div class="header" id="gameHeader">
        <h1>üéπ Èí¢Áê¥Âùó</h1>
        <div class="header-actions">
            <span class="user-info" id="userInfo">Ê∏∏ÂÆ¢</span>
            <button class="leaderboard-btn" id="leaderboardBtn">üèÜ ÊéíË°åÊ¶ú</button>
            <button class="music-btn" id="musicBtn">üéµ Èü≥‰πê</button>
            <button class="sfx-btn" id="sfxBtn">üîä Èü≥Êïà</button>
            <button class="header-btn" id="createBtn">+ Âà∂‰Ωú</button>
            <button class="admin-btn" id="adminBtn" style="display:none;">‚öôÔ∏è ÂÆ°Ê†∏</button>
        </div>
    </div>

    <div class="screen" id="lobbyScreen">
        <div class="lobby-container" id="lobbyContainer"></div>
    </div>

    <div class="screen" id="editorScreen">
        <div class="editor-container">
            <div class="editor-header">
                <button class="editor-btn secondary" id="backBtn">‚Üê ËøîÂõû</button>
                <input type="text" id="songTitle" placeholder="Ê≠åÊõ≤ÂêçÁß∞">
                <div class="speed-control">
                    <span>ÈÄüÂ∫¶:</span>
                    <input type="number" id="songSpeed" value="1.0" step="0.1" min="0.5" max="2.0">
                </div>
                <div class="duration-control">
                    <span>ÈïøÂ∫¶:</span>
                    <div class="duration-buttons">
                        <button class="duration-btn" data-duration="200">Áü≠</button>
                        <button class="duration-btn active" data-duration="400">‰∏≠</button>
                        <button class="duration-btn" data-duration="800">Èïø</button>
                        <button class="duration-btn" data-duration="1200">ÁâπÈïø</button>
                    </div>
                    <input type="number" id="customDuration" value="400" step="50" min="100" max="5000" placeholder="Ëá™ÂÆö‰πâÈïøÂ∫¶">
                    <button class="editor-btn secondary" id="setDurationBtn">ËÆæÁΩÆ</button>
                </div>
                <div class="octave-control">
                    <span>ÂÖ´Â∫¶:</span>
                    <select id="octaveSelect">
                        <option value="0">‰ΩéÂÖ´Â∫¶</option>
                        <option value="1" selected>‰∏≠ÂÖ´Â∫¶</option>
                        <option value="2">È´òÂÖ´Â∫¶</option>
                    </select>
                </div>
                <button class="editor-btn secondary" id="deleteBtn">Âà†Èô§Ê®°Âºè</button>
                <button class="editor-btn primary" id="saveBtn">ÂèëÂ∏É</button>
            </div>
            <div class="editor-area">
                <div class="editor-tracks" id="editorTracks">
                    <div class="editor-track" data-track="0"></div>
                    <div class="editor-track" data-track="1"></div>
                    <div class="editor-track" data-track="2"></div>
                    <div class="editor-track" data-track="3"></div>
                    <div class="editor-track" data-track="4"></div>
                    <div class="editor-track" data-track="5"></div>
                    <div class="editor-track" data-track="6"></div>
                </div>
                <div class="editor-keys">
                    <button class="editor-key track0" data-track="0"><span>1</span><small>C</small></button>
                    <button class="editor-key track1" data-track="1"><span>2</span><small>D</small></button>
                    <button class="editor-key track2" data-track="2"><span>3</span><small>E</small></button>
                    <button class="editor-key track3" data-track="3"><span>4</span><small>F</small></button>
                    <button class="editor-key track4" data-track="4"><span>5</span><small>G</small></button>
                    <button class="editor-key track5" data-track="5"><span>6</span><small>A</small></button>
                    <button class="editor-key track6" data-track="6"><span>7</span><small>B</small></button>
                </div>
                <div class="editor-empty-tip" id="editorTip">ÁÇπÂáªÊåâÈîÆÊ∑ªÂä†Èü≥Á¨¶</div>
            </div>
            <div class="playback-controls">
                <button class="editor-btn secondary" id="previewBtn">‚ñ∂ È¢ÑËßà</button>
                <button class="editor-btn secondary" id="clearBtn">Ê∏ÖÁ©∫</button>
            </div>
        </div>
    </div>

    <div class="screen" id="gameScreen">
        <div class="game-container">
            <button class="game-back-btn" id="gameBackBtn">‚Üê ËøîÂõû</button>
            <div class="volume-control">
                <button class="volume-btn" id="volumeBtn">üîä <span id="volumeLevel">80%</span></button>
                <div class="volume-slider" id="volumeSlider">
                    <input type="range" id="volumeRange" min="0" max="100" value="80">
                    <div class="volume-level" id="volumeLevelDisplay">80%</div>
                </div>
            </div>
            <div class="track-container" id="trackContainer"></div>
            <div class="key-line"></div>
            <div class="keys" id="gameKeys"></div>
            <div class="score-display">ÂæóÂàÜ: <span id="score">0</span></div>
            <div class="combo-display">ËøûÂáª: <span id="combo">0</span></div>
            <div class="message" id="message"></div>
            <div class="start-overlay" id="startOverlay">
                <div class="title-text" id="gameTitle">Ê≠åÊõ≤Âêç</div>
                <button class="start-btn" id="gameStartBtn">ÂºÄÂßãÊ∏∏Êàè</button>
                <div class="final-score" id="finalScore" style="display: none;">
                    ÂæóÂàÜ: <span id="finalScoreValue">0</span>
                </div>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>
    <div class="confirm-dialog" id="confirmDialog">
        <div class="confirm-content">
            <h3 id="confirmText">Á°ÆËÆ§ÂèëÂ∏É?</h3>
            <div class="confirm-buttons">
                <button class="confirm-btn cancel" id="confirmCancel">ÂèñÊ∂à</button>
                <button class="confirm-btn confirm" id="confirmOk">Á°ÆËÆ§</button>
            </div>
        </div>
    </div>

    <div class="leaderboard-dialog" id="leaderboardDialog">
        <div class="leaderboard-content">
            <div class="leaderboard-header">
                <h2>üèÜ ÊéíË°åÊ¶ú</h2>
                <button class="leaderboard-close" id="leaderboardClose">&times;</button>
            </div>
            <div class="leaderboard-list" id="leaderboardList">
                <!-- ÊéíË°åÊ¶úÂÜÖÂÆπÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÁîüÊàê -->
            </div>
        </div>
    </div>

    <!-- ÁÆ°ÁêÜÂëòÂÆ°Ê†∏ÂºπÁ™ó -->
    <div class="leaderboard-dialog" id="adminDialog">
        <div class="leaderboard-content">
            <div class="leaderboard-header">
                <h2>‚öôÔ∏è Ê≠åÊõ≤ÂÆ°Ê†∏</h2>
                <button class="leaderboard-close" id="adminClose">&times;</button>
            </div>
            <div class="admin-list" id="adminList">
                <!-- ÂæÖÂÆ°Ê†∏Ê≠åÊõ≤ÂàóË°® -->
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://afibpljofhbzgkvmgpil.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_URlgq9x3cvSHKLq-LHHSXA_cvRxzMVn';
        
        let supabaseClient;
        
        // ÂàùÂßãÂåñSupabaseÂÆ¢Êà∑Á´Ø
        function initSupabase() {
            try {
                if (window.supabase && window.supabase.createClient) {
                    supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                    console.log('SupabaseÂÆ¢Êà∑Á´ØÂàùÂßãÂåñÊàêÂäü');
                    return true;
                } else if (window.createClient) {
                    supabaseClient = window.createClient(SUPABASE_URL, SUPABASE_KEY);
                    console.log('SupabaseÂÆ¢Êà∑Á´ØÂàùÂßãÂåñÊàêÂäü (‰ΩøÁî®ÂÖ®Â±ÄcreateClient)');
                    return true;
                } else {
                    console.error('SupabaseÂ∫ìÊú™Ê≠£Á°ÆÂä†ËΩΩ');
                    return false;
                }
            } catch (error) {
                console.error('SupabaseÂàùÂßãÂåñÂ§±Ë¥•:', error);
                return false;
            }
        }
        
        // ÂàùÂßãÂåñËÉåÊôØÈü≥‰πê - ‰ΩøÁî®Êõ¥ÊüîÂíåÁöÑÈü≥Ëâ≤
        function initBackgroundMusic() {
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }

            if (!backgroundMusic) {
                backgroundMusic = {
                    bass: audioContext.createOscillator(),
                    chord1: audioContext.createOscillator(),
                    chord2: audioContext.createOscillator(),
                    bassGain: audioContext.createGain(),
                    chord1Gain: audioContext.createGain(),
                    chord2Gain: audioContext.createGain(),
                    chordPattern: [0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 1, 0, 1],
                    bassPattern: [1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0],
                    step: 0,
                    tempo: 90,
                    interval: null
                };

                backgroundMusic.bass.type = 'sine';
                backgroundMusic.bass.frequency.setValueAtTime(65.41, audioContext.currentTime);

                backgroundMusic.chord1.type = 'triangle';
                backgroundMusic.chord1.frequency.setValueAtTime(130.81, audioContext.currentTime);

                backgroundMusic.chord2.type = 'triangle';
                backgroundMusic.chord2.frequency.setValueAtTime(164.81, audioContext.currentTime);

                backgroundMusic.bass.connect(backgroundMusic.bassGain);
                backgroundMusic.chord1.connect(backgroundMusic.chord1Gain);
                backgroundMusic.chord2.connect(backgroundMusic.chord2Gain);

                const filter = audioContext.createBiquadFilter();
                filter.type = 'lowpass';
                filter.frequency.setValueAtTime(800, audioContext.currentTime);

                backgroundMusic.bassGain.connect(filter);
                backgroundMusic.chord1Gain.connect(filter);
                backgroundMusic.chord2Gain.connect(filter);
                filter.connect(audioContext.destination);

                backgroundMusic.bassGain.connect(audioContext.destination);
                backgroundMusic.chord1Gain.connect(audioContext.destination);
                backgroundMusic.chord2Gain.connect(audioContext.destination);

                backgroundMusic.bassGain.gain.setValueAtTime(0, audioContext.currentTime);
                backgroundMusic.chord1Gain.gain.setValueAtTime(0, audioContext.currentTime);
                backgroundMusic.chord2Gain.gain.setValueAtTime(0, audioContext.currentTime);

                backgroundMusic.bass.start();
                backgroundMusic.chord1.start();
                backgroundMusic.chord2.start();

                backgroundMusicVolume = 0.4;
            }
        }

        function playBackgroundMusic() {
            if (!backgroundMusic) {
                initBackgroundMusic();
            }

            if (!backgroundMusic.interval) {
                const stepDuration = (60 / backgroundMusic.tempo) / 4;
                
                backgroundMusic.interval = setInterval(() => {
                    if (!isBackgroundMusicPlaying) return;

                    const currentTime = audioContext.currentTime;
                    
                    if (backgroundMusic.bassPattern[backgroundMusic.step] === 1) {
                        backgroundMusic.bassGain.gain.setValueAtTime(backgroundMusicVolume * 0.6, currentTime);
                        backgroundMusic.bassGain.gain.exponentialRampToValueAtTime(0.01, currentTime + 0.4);
                    }

                    if (backgroundMusic.chordPattern[backgroundMusic.step] === 1) {
                        backgroundMusic.chord1Gain.gain.setValueAtTime(backgroundMusicVolume * 0.4, currentTime);
                        backgroundMusic.chord1Gain.gain.exponentialRampToValueAtTime(0.01, currentTime + 0.3);
                    }

                    if (backgroundMusic.step % 8 === 3 || backgroundMusic.step % 8 === 7) {
                        backgroundMusic.chord2Gain.gain.setValueAtTime(backgroundMusicVolume * 0.3, currentTime);
                        backgroundMusic.chord2Gain.gain.exponentialRampToValueAtTime(0.01, currentTime + 0.25);
                    }

                    backgroundMusic.step = (backgroundMusic.step + 1) % 16;
                }, stepDuration * 1000);

                isBackgroundMusicPlaying = true;
                updateMusicButton();
            }
        }

        // ÂÅúÊ≠¢ËÉåÊôØÈü≥‰πê
        function stopBackgroundMusic() {
            if (backgroundMusic && backgroundMusic.interval) {
                clearInterval(backgroundMusic.interval);
                backgroundMusic.interval = null;
            }
            isBackgroundMusicPlaying = false;
            updateMusicButton();
        }

        // ÂàáÊç¢ËÉåÊôØÈü≥‰πêÁä∂ÊÄÅ
        function toggleBackgroundMusic() {
            if (isBackgroundMusicPlaying) {
                stopBackgroundMusic();
            } else {
                playBackgroundMusic();
            }
        }

        // Êõ¥Êñ∞Èü≥‰πêÊåâÈíÆÁä∂ÊÄÅ
        function updateMusicButton() {
            const musicBtn = document.getElementById('musicBtn');
            const splashMusicBtn = document.getElementById('splashMusicBtn');
            const authMusicBtn = document.getElementById('authMusicBtn');
            
            const updateBtn = (btn) => {
                if (btn) {
                    if (isBackgroundMusicPlaying) {
                        btn.textContent = 'üéµ Èü≥‰πê';
                        btn.classList.remove('muted');
                    } else {
                        btn.textContent = 'üîá ÈùôÈü≥';
                        btn.classList.add('muted');
                    }
                }
            };
            
            updateBtn(musicBtn);
            updateBtn(splashMusicBtn);
            updateBtn(authMusicBtn);
        }

        // Êõ¥Êñ∞ÊïàÊûúÈü≥ÊåâÈíÆÁä∂ÊÄÅ
        function updateSfxButton() {
            const sfxBtn = document.getElementById('sfxBtn');
            if (sfxBtn) {
                if (soundEffectsEnabled) {
                    sfxBtn.textContent = 'üîä Èü≥Êïà';
                    sfxBtn.classList.remove('muted');
                } else {
                    sfxBtn.textContent = 'üîá ÈùôÈü≥';
                    sfxBtn.classList.add('muted');
                }
            }
        }

        // È°µÈù¢Âä†ËΩΩÊó∂ÂàùÂßãÂåñ
        window.addEventListener('load', function() {
            try {
                initSupabase();
                // Âª∂ËøüÂàùÂßãÂåñËÉåÊôØÈü≥‰πêÔºåÁ°Æ‰øùÁî®Êà∑‰∫§‰∫íÂêé
                setTimeout(() => {
                    initBackgroundMusic();
                    playBackgroundMusic();
                }, 1000);
            } catch (error) {
                console.error('È°µÈù¢Âä†ËΩΩÂàùÂßãÂåñÂ§±Ë¥•:', error);
            }
            return false;
        });

        // ÁßªÈô§Ê®™Â±èÊèêÁ§∫ÔºåÁõ¥Êé•ÂÖÅËÆ∏Ê∏∏Êàè

        const noteFreqs = {
            0: 261.63,
            1: 293.66,
            2: 329.63,
            3: 349.23,
            4: 392.00,
            5: 440.00,
            6: 493.88
        };

        const noteNames = ['C', 'D', 'E', 'F', 'G', 'A', 'B'];

        let currentScreen = 'splash';
        let currentSong = null;
        let editorNotes = [];
        let isPlaying = false;
        let score = 0;
        let combo = 0;
        let gameStartTime = 0;
        let animationId = null;

        // Áî®Êà∑Áä∂ÊÄÅ
        let currentUser = null;
        let isAuthModeLogin = true; // true‰∏∫ÁôªÂΩïÔºåfalse‰∏∫Ê≥®ÂÜå

        const audioContext = new (window.AudioContext || window.webkitAudioContext)();

        function showToast(text) {
            const toast = document.getElementById('toast');
            toast.textContent = text;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2000);
        }

        function showConfirm(text, callback) {
            const dialog = document.getElementById('confirmDialog');
            document.getElementById('confirmText').textContent = text;
            dialog.classList.add('show');
            
            document.getElementById('confirmOk').onclick = () => {
                dialog.classList.remove('show');
                callback();
            };
            document.getElementById('confirmCancel').onclick = () => {
                dialog.classList.remove('show');
            };
        }

        function showScreen(screen) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screen + 'Screen').classList.add('active');
            currentScreen = screen;
        }

        async function loadSongs(searchQuery = '') {
            const container = document.getElementById('lobbyContainer');
            
            // Ê∑ªÂä†ÊêúÁ¥¢Ê°Ü
            container.innerHTML = `
                <div class="search-container">
                    <div class="search-box">
                        <input type="text" class="search-input" id="searchInput" placeholder="ÊêúÁ¥¢Ê≠åÊõ≤ÂêçÁß∞Êàñ‰ΩúËÄÖ..." value="${searchQuery}">
                        <button class="search-btn" id="searchBtn">ÊêúÁ¥¢</button>
                    </div>
                </div>
                <div class="loading">Âä†ËΩΩ‰∏≠...</div>
            `;
            
            // Ê∑ªÂä†ÊêúÁ¥¢‰∫ã‰ª∂
            document.getElementById('searchBtn').addEventListener('click', function() {
                const query = document.getElementById('searchInput').value.trim();
                loadSongs(query);
                return false;
            });
            
            document.getElementById('searchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    const query = this.value.trim();
                    loadSongs(query);
                }
                return false;
            });
            
            try {
                if (!supabaseClient) {
                    throw new Error('SupabaseÂÆ¢Êà∑Á´ØÊú™ÂàùÂßãÂåñ');
                }
                
                let query = supabaseClient
                    .from('songs')
                    .select('*')
                    .eq('status', 'approved')
                    .order('created_at', { ascending: false });
                
                // Ê∑ªÂä†ÊêúÁ¥¢Êù°‰ª∂
                if (searchQuery) {
                    query = query.or(`title.ilike.%${searchQuery}%,author.ilike.%${searchQuery}%`);
                }
                
                const { data, error } = await query;
                
                if (error) {
                    console.error('SupabaseÈîôËØØ:', error);
                    throw error;
                }
                
                console.log('Âä†ËΩΩÂà∞ÁöÑÊ≠åÊõ≤:', data);
                
                if (!data || data.length === 0) {
                    container.innerHTML = `
                        <div class="search-container">
                            <div class="search-box">
                                <input type="text" class="search-input" id="searchInput" placeholder="ÊêúÁ¥¢Ê≠åÊõ≤ÂêçÁß∞Êàñ‰ΩúËÄÖ..." value="${searchQuery}">
                                <button class="search-btn" id="searchBtn">ÊêúÁ¥¢</button>
                            </div>
                        </div>
                        <div class="empty-state">ÊöÇÊó†Ê≠åÊõ≤<br>ÁÇπÂáª"Âà∂‰Ωú"ÂàõÂª∫‰Ω†ÁöÑ‰ΩúÂìÅ!</div>
                    `;
                    
                    document.getElementById('searchBtn').addEventListener('click', function() {
                        const query = document.getElementById('searchInput').value.trim();
                        loadSongs(query);
                        return false;
                    });
                    
                    document.getElementById('searchInput').addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            const query = this.value.trim();
                            loadSongs(query);
                        }
                        return false;
                    });
                    return;
                }
                
                // Âä†ËΩΩÁî®Êà∑ÂàÜÊï∞
                let userScores = {};
                if (currentUser) {
                    const { data: scores } = await supabaseClient
                        .from('scores')
                        .select('song_id, score')
                        .eq('user_id', currentUser.id);
                    
                    if (scores) {
                        scores.forEach(s => {
                            userScores[s.song_id] = s.score;
                        });
                    }
                }
                
                // Âä†ËΩΩÁî®Êà∑ÁÇπËµû
                let userLikes = {};
                if (currentUser) {
                    const { data: likes } = await supabaseClient
                        .from('likes')
                        .select('song_id')
                        .eq('user_id', currentUser.id);
                    
                    if (likes) {
                        likes.forEach(l => {
                            userLikes[l.song_id] = true;
                        });
                    }
                }
                
                container.innerHTML = `
                    <div class="search-container">
                        <div class="search-box">
                            <input type="text" class="search-input" id="searchInput" placeholder="ÊêúÁ¥¢Ê≠åÊõ≤ÂêçÁß∞Êàñ‰ΩúËÄÖ..." value="${searchQuery}">
                            <button class="search-btn" id="searchBtn">ÊêúÁ¥¢</button>
                        </div>
                    </div>
                    ${data.map(song => `
                        <div class="song-card" data-id="${song.id}">
                            <button class="like-btn ${userLikes[song.id] ? 'liked' : ''}" data-song-id="${song.id}">‚ù§Ô∏è</button>
                            <div class="title">${song.title}</div>
                            <div class="author">by ${song.author}</div>
                            <div class="stats">
                                <span>üéµ ${Array.isArray(song.notes) ? song.notes.length : 0}</span>
                                <span>‚ñ∂ ${song.play_count || 0}</span>
                                <span>‚ù§Ô∏è ${song.like_count || 0}</span>
                            </div>
                            ${currentUser && userScores[song.id] ? `<div class="user-score">‰Ω†ÁöÑÊúÄÈ´òÂàÜ: ${userScores[song.id]}</div>` : ''}
                        </div>
                    `).join('')}
                `;
                
                // Ê∑ªÂä†Ê≠åÊõ≤ÁÇπÂáª‰∫ã‰ª∂
                container.querySelectorAll('.song-card').forEach(card => {
                    card.addEventListener('click', () => playSong(card.dataset.id));
                });
                
                // ÈáçÊñ∞ÁªëÂÆöÊêúÁ¥¢‰∫ã‰ª∂
                document.getElementById('searchBtn').addEventListener('click', function() {
                    const query = document.getElementById('searchInput').value.trim();
                    loadSongs(query);
                    return false;
                });
                
                document.getElementById('searchInput').addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        const query = this.value.trim();
                        loadSongs(query);
                    }
                    return false;
                });
                
                // Ê∑ªÂä†ÁÇπËµû‰∫ã‰ª∂
                container.querySelectorAll('.like-btn').forEach(btn => {
                    btn.addEventListener('click', async function(e) {
                        e.stopPropagation();
                        if (!currentUser) {
                            showToast('ËØ∑ÂÖàÁôªÂΩï');
                            return;
                        }
                        
                        const songId = this.dataset.songId;
                        const isLiked = this.classList.contains('liked');
                        
                        try {
                            if (isLiked) {
                                // ÂèñÊ∂àÁÇπËµû
                                await supabaseClient
                                    .from('likes')
                                    .delete()
                                    .eq('user_id', currentUser.id)
                                    .eq('song_id', songId);
                                
                                await supabaseClient
                                    .from('songs')
                                    .update({ like_count: (data.find(s => s.id === songId)?.like_count || 0) - 1 })
                                    .eq('id', songId);
                                
                                this.classList.remove('liked');
                                showToast('Â∑≤ÂèñÊ∂àÁÇπËµû');
                            } else {
                                // Ê∑ªÂä†ÁÇπËµû
                                await supabaseClient
                                    .from('likes')
                                    .insert({
                                        user_id: currentUser.id,
                                        song_id: songId
                                    });
                                
                                await supabaseClient
                                    .from('songs')
                                    .update({ like_count: (data.find(s => s.id === songId)?.like_count || 0) + 1 })
                                    .eq('id', songId);
                                
                                this.classList.add('liked');
                                showToast('Â∑≤ÁÇπËµû');
                            }
                            
                            // ÈáçÊñ∞Âä†ËΩΩÊ≠åÊõ≤
                            loadSongs(searchQuery);
                        } catch (err) {
                            showToast('Êìç‰ΩúÂ§±Ë¥•: ' + err.message);
                        }
                    });
                });
            } catch (err) {
                console.error('Âä†ËΩΩÊ≠åÊõ≤Â§±Ë¥•:', err);
                container.innerHTML = `
                    <div class="search-container">
                        <div class="search-box">
                            <input type="text" class="search-input" id="searchInput" placeholder="ÊêúÁ¥¢Ê≠åÊõ≤ÂêçÁß∞Êàñ‰ΩúËÄÖ..." value="${searchQuery}">
                            <button class="search-btn" id="searchBtn">ÊêúÁ¥¢</button>
                        </div>
                    </div>
                    <div class="empty-state">Âä†ËΩΩÂ§±Ë¥•<br>ÈîôËØØ: ${err.message}</div>
                `;
            }
        }

        // ÊòæÁ§∫ÊéíË°åÊ¶ú
        async function showLeaderboard() {
            const dialog = document.getElementById('leaderboardDialog');
            const list = document.getElementById('leaderboardList');
            
            list.innerHTML = '<div class="loading">Âä†ËΩΩ‰∏≠...</div>';
            dialog.classList.add('show');
            
            try {
                if (!supabaseClient) {
                    throw new Error('SupabaseÂÆ¢Êà∑Á´ØÊú™ÂàùÂßãÂåñ');
                }
                
                // Âä†ËΩΩÁî®Êà∑ÊÄªÂàÜ
                const { data: users, error } = await supabaseClient
                    .from('users')
                    .select('id, total_score')
                    .order('total_score', { ascending: false })
                    .limit(20);
                
                if (error) {
                    console.error('Âä†ËΩΩÊéíË°åÊ¶úÂ§±Ë¥•:', error);
                    throw error;
                }
                
                if (!users || users.length === 0) {
                    list.innerHTML = '<div class="empty-state">ÊöÇÊó†ÊéíË°åÊï∞ÊçÆ</div>';
                    return;
                }
                
                list.innerHTML = users.map((user, index) => {
                    const isTop = index < 3;
                    const isCurrentUser = currentUser && user.id === currentUser.id;
                    return `
                        <div class="leaderboard-item ${isTop ? 'top' : ''} ${isCurrentUser ? 'current-user' : ''}">
                            <span class="leaderboard-rank">${index + 1}</span>
                            <span class="leaderboard-id">${user.id}</span>
                            <span class="leaderboard-score">${user.total_score || 0}</span>
                        </div>
                    `;
                }).join('');
            } catch (err) {
                list.innerHTML = `<div class="empty-state">Âä†ËΩΩÂ§±Ë¥•: ${err.message}</div>`;
            }
        }

        // ÁÆ°ÁêÜÂëòÂÆ°Ê†∏Èù¢Êùø - ÁÆ°ÁêÜÊâÄÊúâÊ≠åÊõ≤
        async function showAdminPanel() {
            const dialog = document.getElementById('adminDialog');
            const list = document.getElementById('adminList');
            dialog.classList.add('show');
            
            if (!currentUser || !currentUser.is_admin) {
                list.innerHTML = '<div class="empty-state">Êó†ÊùÉËÆøÈóÆ</div>';
                return;
            }
            
            try {
                // Âä†ËΩΩÊâÄÊúâÊ≠åÊõ≤
                const { data: allSongs, error } = await supabaseClient
                    .from('songs')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                if (!allSongs || allSongs.length === 0) {
                    list.innerHTML = '<div class="empty-state">ÊöÇÊó†Ê≠åÊõ≤</div>';
                    return;
                }
                
                list.innerHTML = allSongs.map(song => `
                    <div class="admin-song-item" data-id="${song.id}">
                        <div class="admin-song-info">
                            <div class="admin-song-title">${song.title}</div>
                            <div class="admin-song-author">‰ΩúËÄÖ: ${song.author || 'Êú™Áü•'} | Áä∂ÊÄÅ: ${song.status || 'approved'}</div>
                        </div>
                        <div class="admin-song-actions">
                            ${song.status !== 'approved' ? `<button class="admin-approve-btn" data-action="approve" data-id="${song.id}">ÈÄöËøá</button>` : ''}
                            <button class="admin-reject-btn" data-action="delete" data-id="${song.id}">Âà†Èô§</button>
                        </div>
                    </div>
                `).join('');
                
                // Ê∑ªÂä†‰∫ã‰ª∂ÂßîÊâò
                list.addEventListener('click', async function(e) {
                    const btn = e.target;
                    const action = btn.dataset.action;
                    const id = btn.dataset.id;
                    
                    if (!action || !id) return;
                    
                    if (action === 'delete') {
                        if (!confirm('Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÈ¶ñÊ≠åÊõ≤ÂêóÔºü')) return;
                        try {
                            const { error } = await supabaseClient.from('songs').delete().eq('id', id);
                            if (error) throw error;
                            showToast('Â∑≤Âà†Èô§');
                            showAdminPanel();
                        } catch (err) {
                            alert('Âà†Èô§Â§±Ë¥•: ' + err.message);
                        }
                    } else if (action === 'approve') {
                        try {
                            const { error } = await supabaseClient.from('songs').update({ status: 'approved' }).eq('id', id);
                            if (error) throw error;
                            showToast('ÂÆ°Ê†∏ÈÄöËøáÔºÅ');
                            showAdminPanel();
                        } catch (err) {
                            alert('Êìç‰ΩúÂ§±Ë¥•: ' + err.message);
                        }
                    }
                });
            } catch (err) {
                list.innerHTML = `<div class="empty-state">Âä†ËΩΩÂ§±Ë¥•: ${err.message}</div>`;
            }
        }

        // ÈÄöËøáÊ≠åÊõ≤
        async function approveSong(songId) {
            try {
                const { error } = await supabaseClient
                    .from('songs')
                    .update({ status: 'approved' })
                    .eq('id', songId);
                
                if (error) throw error;
                
                showToast('ÂÆ°Ê†∏ÈÄöËøáÔºÅ');
                showAdminPanel();
            } catch (err) {
                showToast('Êìç‰ΩúÂ§±Ë¥•: ' + err.message);
            }
        }

        // Âà†Èô§Ê≠åÊõ≤
        async function deleteSong(songId) {
            if (!confirm('Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÈ¶ñÊ≠åÊõ≤ÂêóÔºü')) return;
            
            try {
                console.log('Â∞ùËØïÂà†Èô§Ê≠åÊõ≤ÔºåID:', songId, 'Á±ªÂûã:', typeof songId);
                console.log('SupabaseÂÆ¢Êà∑Á´Ø:', supabaseClient);
                console.log('Áî®Êà∑:', currentUser);
                
                // ÂÖàÊµãËØï‰∏Ä‰∏ãËÉΩÂê¶ËØªÂèñ
                const testRead = await supabaseClient
                    .from('songs')
                    .select('id')
                    .eq('id', songId);
                console.log('ÊµãËØïËØªÂèñ:', testRead);
                
                const { error, data } = await supabaseClient
                    .from('songs')
                    .delete()
                    .eq('id', songId)
                    .select();
                
                console.log('Âà†Èô§ÁªìÊûú:', { error, data });
                
                if (error) {
                    alert('Âà†Èô§Â§±Ë¥•: ' + error.message);
                    throw error;
                }
                
                showToast('Â∑≤Âà†Èô§');
                showAdminPanel();
            } catch (err) {
                alert('Âà†Èô§Â§±Ë¥•: ' + err.message);
                console.error('Âà†Èô§Ê≠åÊõ≤ËØ¶ÁªÜÈîôËØØ:', err);
            }
        }

        // ÊãíÁªùÊ≠åÊõ≤Ôºà‰øùÁïô‰ΩÜ‰∏ç‰∏äÊû∂Ôºâ
        async function rejectSong(songId) {
            try {
                const { error } = await supabaseClient
                    .from('songs')
                    .update({ status: 'rejected' })
                    .eq('id', songId);
                
                if (error) {
                    alert('Êìç‰ΩúÂ§±Ë¥•: ' + error.message);
                    throw error;
                }
                
                showToast('Â∑≤ÊãíÁªù');
                showAdminPanel();
            } catch (err) {
                alert('Êìç‰ΩúÂ§±Ë¥•: ' + err.message);
            }
        }

        // ÈÄöËøáÊ≠åÊõ≤
        async function approveSong(songId) {
            try {
                const { error } = await supabaseClient
                    .from('songs')
                    .update({ status: 'approved' })
                    .eq('id', songId);
                
                if (error) {
                    alert('Êìç‰ΩúÂ§±Ë¥•: ' + error.message);
                    throw error;
                }
                
                showToast('ÂÆ°Ê†∏ÈÄöËøáÔºÅ');
                showAdminPanel();
            } catch (err) {
                alert('Êìç‰ΩúÂ§±Ë¥•: ' + err.message);
            }
        }

        // ÊääÂáΩÊï∞Êö¥Èú≤Âà∞ÂÖ®Â±Ä
        window.approveSong = approveSong;
        window.deleteSong = deleteSong;
        window.rejectSong = rejectSong;

        async function playSong(songId) {
            try {
                if (!supabaseClient) {
                    showToast('SupabaseÊú™ÂàùÂßãÂåñ');
                    return;
                }
                
                const { data, error } = await supabaseClient
                    .from('songs')
                    .select('*')
                    .eq('id', songId)
                    .single();
                
                if (error || !data) {
                    console.error('Âä†ËΩΩÊ≠åÊõ≤Â§±Ë¥•:', error);
                    showToast('Âä†ËΩΩÂ§±Ë¥•: ' + (error?.message || 'Êú™Áü•ÈîôËØØ'));
                    return;
                }
                
                console.log('Âä†ËΩΩÁöÑÊ≠åÊõ≤Êï∞ÊçÆ:', data);
                currentSong = data;
                
                // ÈáçÁΩÆÊ∏∏ÊàèÁä∂ÊÄÅ
                score = 0;
                combo = 0;
                isPlaying = false;
                
                // Á°Æ‰øùÂºÄÂßãÁïåÈù¢ÊòæÁ§∫
                document.getElementById('score').textContent = '0';
                document.getElementById('combo').textContent = '0';
                document.getElementById('gameTitle').textContent = data.title;
                document.getElementById('finalScore').style.display = 'none';
                document.getElementById('gameStartBtn').style.display = 'block';
                document.getElementById('startOverlay').style.display = 'flex';
                
                // Êõ¥Êñ∞Êí≠ÊîæÊ¨°Êï∞
                await supabaseClient
                    .from('songs')
                    .update({ play_count: (data.play_count || 0) + 1 })
                    .eq('id', songId);
                
                initGame();
                showScreen('game');
            } catch (err) {
                console.error('Êí≠ÊîæÊ≠åÊõ≤Â§±Ë¥•:', err);
                showToast('Âä†ËΩΩÂ§±Ë¥•: ' + err.message);
            }
        }

        function initGame() {
            const trackContainer = document.getElementById('trackContainer');
            const gameKeys = document.getElementById('gameKeys');
            
            trackContainer.innerHTML = '';
            gameKeys.innerHTML = '';
            
            for (let i = 0; i < 7; i++) {
                const track = document.createElement('div');
                track.className = 'track';
                track.dataset.track = i;
                
                // Êåâ‰∏ã‰∫ã‰ª∂
                track.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    handleGameDown(i);
                    return false;
                }, {passive: false});
                track.addEventListener('mousedown', function() {
                    handleGameDown(i);
                    return false;
                });
                
                // ÊùæÂºÄ‰∫ã‰ª∂
                track.addEventListener('touchend', function() {
                    handleGameUp(i);
                    return false;
                });
                track.addEventListener('mouseup', function() {
                    handleGameUp(i);
                    return false;
                });
                track.addEventListener('mouseleave', function() {
                    handleGameUp(i);
                    return false;
                });
                
                trackContainer.appendChild(track);
                
                const key = document.createElement('button');
                key.className = `key track${i}`;
                key.dataset.track = i;
                key.innerHTML = `<span>${i + 1}</span><small>${noteNames[i]}</small>`;
                
                // Êåâ‰∏ã‰∫ã‰ª∂
                key.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    handleGameDown(i);
                    return false;
                }, {passive: false});
                key.addEventListener('mousedown', function() {
                    handleGameDown(i);
                    return false;
                });
                
                // ÊùæÂºÄ‰∫ã‰ª∂
                key.addEventListener('touchend', function() {
                    handleGameUp(i);
                    key.classList.remove('pressed');
                    return false;
                });
                key.addEventListener('mouseup', function() {
                    handleGameUp(i);
                    key.classList.remove('pressed');
                    return false;
                });
                key.addEventListener('mouseleave', function() {
                    handleGameUp(i);
                    key.classList.remove('pressed');
                    return false;
                });
                
                gameKeys.appendChild(key);
            }
        }

        // Êåâ‰∏ãÂ§ÑÁêÜ
        function handleGameDown(track) {
            const key = document.querySelector(`#gameKeys .key[data-track="${track}"]`);
            if (key) key.classList.add('pressed');
            
            // Ëß¶ÂèëÁÇπÂáªÊ£ÄÊµã
            checkHit(track);
        }

        // ÊùæÂºÄÂ§ÑÁêÜ
        function handleGameUp(track) {
            const key = document.querySelector(`#gameKeys .key[data-track="${track}"]`);
            if (key) key.classList.remove('pressed');
        }

        function playTone(freq, duration, volume = 0.8) {
            if (audioContext.state === 'suspended') audioContext.resume();
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = freq;
            oscillator.type = 'sine';
            
            // ‰ΩøÁî®ÂÖ®Â±ÄÈü≥ÈáèÊéßÂà∂
            const finalVolume = volume * volumeLevel;
            gainNode.gain.setValueAtTime(finalVolume, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + duration);
        }

        let heldTracks = new Set(); // ËÆ∞ÂΩïÊ≠£Âú®Êåâ‰ΩèÁöÑËΩ®ÈÅì
        let eliminatedNotes = new Set(); // ËÆ∞ÂΩïÂ∑≤Ê∂àÈô§ÁöÑÈü≥Á¨¶Á¥¢Âºï

        function checkHit(track) {
            if (!isPlaying) return;
            
            const currentTime = Date.now() - gameStartTime;
            const speed = currentSong?.speed || 1.0;
            const noteSpeed = 0.35 * speed;
            
            const notes = Array.isArray(currentSong?.notes) ? currentSong.notes : [];
            
            for (let i = 0; i < notes.length; i++) {
                const note = notes[i];
                
                // Ë∑≥ËøáÂ∑≤Ê∂àÈô§ÁöÑÈü≥Á¨¶
                if (eliminatedNotes.has(i)) continue;
                
                if (note.track !== track) continue;
                
                // ‰ΩøÁî®‰∏éupdateGameNotes‰∏ÄËá¥ÁöÑËÆ°ÁÆóÂÖ¨Âºè
                const noteReachTime = note.time / speed;
                const timeDiff = currentTime - noteReachTime;
                
                // Âú®Èü≥Á¨¶Âà∞ËææÊåâÈîÆ‰ΩçÁΩÆÈôÑËøëÊó∂ÂÖÅËÆ∏Ê∂àÈô§
                if (Math.abs(timeDiff * noteSpeed) < 150) {
                    eliminateNormalNote(track, i, Math.abs(timeDiff * 1000));
                    break;
                }
            }
        }

        // Ê∂àÈô§ÊôÆÈÄöÊñπÂùó
        function eliminateNormalNote(track, noteIndex, timeDiff) {
            // Ê†áËÆ∞Èü≥Á¨¶‰∏∫Â∑≤Ê∂àÈô§
            eliminatedNotes.add(noteIndex);
            
            const notes = Array.isArray(currentSong?.notes) ? currentSong.notes : [];
            const note = notes[noteIndex];
            
            // ËÆ°ÁÆóÂ∏¶ÂÖ´Â∫¶ÁöÑÈ¢ëÁéá
            const octaveMultiplier = Math.pow(2, (note.octave || 1) - 1);
            const freq = noteFreqs[track] * octaveMultiplier;
            
            // Êí≠ÊîæÈü≥Êïà
            playTone(freq, 0.3, 0.4);
            
            // ËÆ°ÁÆóÊñπÂùó‰∏éÊåâÈîÆÁöÑÈáçÂêàÂ∫¶Âà§ÂÆö
            const containerHeight = document.querySelector('.track-container').offsetHeight;
            const keyLineY = containerHeight - 80;
            const noteSpeed = 0.35 * (currentSong?.speed || 1.0);
            
            const currentTime = Date.now() - gameStartTime;
            const speed = currentSong?.speed || 1.0;
            
            // ËÆ°ÁÆóÈü≥Á¨¶ÂΩìÂâçÁöÑ‰ΩçÁΩÆ
            const noteY = keyLineY - (note.time / speed - currentTime) * noteSpeed;
            
            // ËÆ°ÁÆóÈáçÂêàÂ∫¶ - ÊåâÈîÆ‰ΩçÁΩÆÂú®containerHeight - 80Âà∞containerHeight‰πãÈó¥
            const noteTop = noteY;
            const noteBottom = noteY + 55;
            const keyTop = keyLineY - 10;
            const keyBottom = containerHeight;
            
            // ËÆ°ÁÆóÈáçÂè†Âå∫Âüü
            const overlapTop = Math.max(noteTop, keyTop);
            const overlapBottom = Math.min(noteBottom, keyBottom);
            const overlapHeight = Math.max(0, overlapBottom - overlapTop);
            const noteHeight = 55;
            
            // ÈáçÂêàÁôæÂàÜÊØî
            const overlapPercent = (overlapHeight / noteHeight) * 100;
            
            // Ê†πÊçÆÈáçÂêàÂ∫¶Âà§ÂÆö
            let points = 15;
            let message = '‰∏ÄËà¨';
            
            if (overlapPercent >= 90) {
                points = 100;
                message = 'ÂÆåÁæé! ‚ú®';
                showHitAnimation(track, 'perfect');
                playComboVoice('perfect');
            } else if (overlapPercent >= 60) {
                points = 50;
                message = '‰∏çÈîô! üëç';
                showHitAnimation(track, 'good');
                playComboVoice('good');
            } else {
                showHitAnimation(track, 'normal');
                playComboVoice('normal');
            }
            
            // Êõ¥Êñ∞ÂàÜÊï∞
            score += points;
            combo++;
            document.getElementById('score').textContent = score;
            document.getElementById('combo').textContent = combo;
            showGameMessage(message);
            
            // Ê£ÄÊü•ËøûÂáªÊï∞Ëß¶ÂèëÁâπÊïà
            checkComboEffects();
        }

        // ÊïàÊûúÈü≥ÂºÄÂÖ≥
        let soundEffectsEnabled = true;
        
        // Êí≠ÊîæËøûÂáªËØ≠Èü≥ÊèêÁ§∫
        function playComboVoice(type) {
            if (!soundEffectsEnabled || audioContext.state === 'suspended') return;
            
            const osc = audioContext.createOscillator();
            const gain = audioContext.createGain();
            
            osc.connect(gain);
            gain.connect(audioContext.destination);
            
            // Èü≥ÈáèË∞ÉÂ∞è
            if (type === 'perfect') {
                osc.frequency.setValueAtTime(880, audioContext.currentTime);
                osc.type = 'sine';
                gain.gain.setValueAtTime(0.08, audioContext.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.15);
            } else if (type === 'good') {
                osc.frequency.setValueAtTime(660, audioContext.currentTime);
                osc.type = 'sine';
                gain.gain.setValueAtTime(0.06, audioContext.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.12);
            } else {
                osc.frequency.setValueAtTime(440, audioContext.currentTime);
                osc.type = 'sine';
                gain.gain.setValueAtTime(0.05, audioContext.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
            }
            
            osc.start();
            osc.stop(audioContext.currentTime + 0.2);
        }

        // Ê£ÄÊü•ËøûÂáªÁâπÊïà
        let comboEffectShown = { 20: false, 40: false };
        
        function checkComboEffects() {
            if (combo >= 20 && combo < 40 && !comboEffectShown[20]) {
                showComboEffect('blue');
                showComboMessage(20);
                comboEffectShown[20] = true;
                comboEffectShown[40] = false;
            }
            else if (combo >= 40 && !comboEffectShown[40]) {
                showComboEffect('gold');
                showComboMessage(40);
                comboEffectShown[40] = true;
            }
            if (combo < 20) {
                comboEffectShown[20] = false;
                comboEffectShown[40] = false;
            } else if (combo < 40) {
                comboEffectShown[40] = false;
            }
        }

        // ÊòæÁ§∫ËøûÂáªÁâπÊïà - ÊøÄÂÖâÊïàÊûú
        function showComboEffect(type) {
            const gameScreen = document.getElementById('gameScreen');
            const color = type === 'gold' ? '#ffd700' : '#00bfff';
            const glowColor = type === 'gold' ? 'rgba(255, 215, 0, 0.6)' : 'rgba(0, 191, 255, 0.5)';
            const duration = type === 'gold' ? 2500 : 2000;
            
            // ‰ªéÂ∑¶ËæπÂºÄÂßãÂèëÂ∞ÑÊøÄÂÖâÔºåÈÄêÊ∏êË¶ÜÁõñÊï¥‰∏™Â±èÂπï
            const laser = document.createElement('div');
            laser.style.position = 'absolute';
            laser.style.left = '0';
            laser.style.top = '0';
            laser.style.bottom = '0';
            laser.style.width = '4px';
            laser.style.background = `linear-gradient(180deg, transparent, ${color}, ${color}, transparent)`;
            laser.style.boxShadow = `0 0 20px ${glowColor}, 0 0 40px ${glowColor}`;
            laser.style.zIndex = '50';
            laser.style.pointerEvents = 'none';
            laser.style.opacity = '0';
            
            gameScreen.appendChild(laser);
            
            // ÊøÄÂÖâ‰ªéÂ∑¶ËæπÂø´ÈÄüÊâ´ËøáÊï¥‰∏™Â±èÂπïÁöÑÂä®Áîª
            laser.animate([
                { left: '0', width: '4px', opacity: 1 },
                { left: '0', width: '20px', opacity: 1 },
                { left: '0', width: '100%', opacity: 0.8 },
                { left: '0', width: '100%', opacity: 0 }
            ], {
                duration: duration,
                easing: 'ease-out'
            });
            
            // ÂêåÊó∂Ê∑ªÂä†ËæπÊ°ÜÂèëÂÖâÊïàÊûú - ‰ΩøÁî®Âõõ‰∏™ËæπÊ°Ü
            const borderTop = document.createElement('div');
            const borderRight = document.createElement('div');
            const borderBottom = document.createElement('div');
            const borderLeft = document.createElement('div');
            
            const borders = [borderTop, borderRight, borderBottom, borderLeft];
            const borderStyles = [
                { top: '0', left: '0', right: '0', height: '4px', origin: 'top' },
                { top: '0', right: '0', bottom: '0', width: '4px', origin: 'right' },
                { bottom: '0', left: '0', right: '0', height: '4px', origin: 'bottom' },
                { top: '0', left: '0', bottom: '0', width: '4px', origin: 'left' }
            ];
            
            borders.forEach((border, i) => {
                Object.assign(border.style, {
                    position: 'absolute',
                    background: `linear-gradient(${borderStyles[i].origin === 'left' || borderStyles[i].origin === 'right' ? '180deg' : '90deg'}, transparent, ${color}, transparent)`,
                    boxShadow: `0 0 15px ${glowColor}`,
                    zIndex: '49',
                    pointerEvents: 'none',
                    opacity: '0',
                    ...borderStyles[i]
                });
                gameScreen.appendChild(border);
            });
            
            // ËæπÊ°ÜÈÄêÊ∏êÂá∫Áé∞Âπ∂Ê∂àÂ§±
            const appearDuration = duration * 0.7;
            borders.forEach((border, i) => {
                setTimeout(() => {
                    border.animate([
                        { opacity: 0 },
                        { opacity: 0.8 },
                        { opacity: 0.8 },
                        { opacity: 0 }
                    ], { duration: appearDuration, easing: 'ease-out' });
                }, i * 150);
            });
            
            setTimeout(() => {
                laser.remove();
                borders.forEach(b => b.remove());
            }, duration);
        }

        // ÊòæÁ§∫ËøûÂáªÊèêÁ§∫ - ÊîæÂú®‰∏äÊñπÈÅøÂºÄÊ∂àÈô§Âä®Áîª
        function showComboMessage(count) {
            const msg = document.createElement('div');
            msg.style.position = 'absolute';
            msg.style.top = '15%';
            msg.style.left = '50%';
            msg.style.transform = 'translate(-50%, -50%)';
            msg.style.color = count >= 40 ? '#ffd700' : '#00bfff';
            msg.style.fontSize = '2.5rem';
            msg.style.fontWeight = 'bold';
            msg.style.textShadow = `0 0 30px ${count >= 40 ? 'rgba(255, 215, 0, 0.9)' : 'rgba(0, 191, 255, 0.9)'}, 0 0 60px ${count >= 40 ? 'rgba(255, 215, 0, 0.5)' : 'rgba(0, 191, 255, 0.5)'}`;
            msg.style.zIndex = '200';
            msg.style.pointerEvents = 'none';
            msg.style.opacity = '0';
            msg.textContent = count + ' COMBO!';
            
            document.getElementById('gameScreen').appendChild(msg);
            
            msg.animate([
                { opacity: 0, transform: 'translate(-50%, -50%) scale(0.3)' },
                { opacity: 1, transform: 'translate(-50%, -50%) scale(1.3)' },
                { opacity: 1, transform: 'translate(-50%, -50%) scale(1)' },
                { opacity: 0, transform: 'translate(-50%, -50%) scale(1.4)' }
            ], { duration: 1500, easing: 'ease-out' });
            
            setTimeout(() => msg.remove(), 1500);
        }

        // ÊòæÁ§∫Ê∂àÈô§Âä®Áîª - Ê∞¥Ê≥¢ÂçäÂúÜÂêë‰∏äÊâ©Êï£
        function showHitAnimation(track, type) {
            const trackContainer = document.getElementById('trackContainer');
            const trackElements = trackContainer.querySelectorAll('.track');
            const targetTrack = trackElements[track];
            
            if (!targetTrack) return;
            
            // Ëé∑ÂèñËΩ®ÈÅìÁöÑ‰ΩçÁΩÆ‰ø°ÊÅØ
            const trackRect = targetTrack.getBoundingClientRect();
            const containerRect = trackContainer.getBoundingClientRect();
            const centerX = trackRect.left - containerRect.left + trackRect.width / 2;
            const centerY = containerRect.height - 80 - 20;
            
            // Ê∞¥Ê≥¢È¢úËâ≤ - ÈáëËâ≤Ë¶ÅÊõ¥Ê∑°
            let waveColor, glowColor, waveCount;
            if (type === 'perfect') {
                waveColor = 'rgba(255, 215, 0, 0.5)';
                glowColor = 'rgba(255, 215, 0, 0.25)';
                waveCount = 2;
            } else if (type === 'good') {
                waveColor = 'rgba(0, 191, 255, 0.7)';
                glowColor = 'rgba(0, 191, 255, 0.3)';
                waveCount = 1;
            } else {
                waveColor = 'rgba(255, 255, 255, 0.5)';
                glowColor = 'rgba(255, 255, 255, 0.2)';
                waveCount = 1;
            }
            
            // ÂàõÂª∫1-2Â±ÇÂçäÂúÜÂΩ¢Ê∞¥Ê≥¢
            for (let w = 0; w < waveCount; w++) {
                setTimeout(() => {
                    const wave = document.createElement('div');
                    wave.style.position = 'absolute';
                    wave.style.left = centerX + 'px';
                    wave.style.top = centerY + 'px';
                    wave.style.width = '10px';
                    wave.style.height = '10px';
                    wave.style.borderRadius = '50%';
                    wave.style.background = `radial-gradient(circle, ${waveColor} 0%, transparent 70%)`;
                    wave.style.transform = 'translate(-50%, -50%)';
                    wave.style.pointerEvents = 'none';
                    wave.style.zIndex = '100';
                    
                    trackContainer.appendChild(wave);
                    
                    // ÂçäÂúÜÂêë‰∏äÊâ©Êï£ÁöÑÂä®Áîª
                    const duration = type === 'perfect' ? 800 : 500;
                    const maxHeight = type === 'perfect' ? 350 : 300;
                    
                    wave.animate([
                        { 
                            transform: 'translate(-50%, -50%) scale(1)',
                            opacity: 0.7
                        },
                        { 
                            transform: `translate(-50%, -50%) scale(${type === 'perfect' ? 20 : 20})`,
                            height: maxHeight + 'px',
                            width: (type === 'perfect' ? 150 : 150) + 'px',
                            top: (centerY - maxHeight) + 'px',
                            opacity: 0
                        }
                    ], {
                        duration: duration,
                        easing: 'ease-out'
                    });
                    
                    setTimeout(() => wave.remove(), duration);
                }, w * 150);
            }
            
            // ÊåâÈîÆÈó™ÂÖâÊïàÊûú
            const keyElements = document.getElementById('gameKeys').querySelectorAll('.key');
            const targetKey = keyElements[track];
            
            if (type === 'perfect') {
                targetKey.style.boxShadow = `0 0 40px ${glowColor}, inset 0 0 25px rgba(255, 255, 255, 0.4), 0 -80px 60px ${glowColor}`;
                setTimeout(() => { targetKey.style.boxShadow = ''; }, 400);
            } else if (type === 'good') {
                targetKey.style.boxShadow = `0 0 35px ${glowColor}, inset 0 0 18px rgba(255, 255, 255, 0.35), 0 -50px 40px ${glowColor}`;
                setTimeout(() => { targetKey.style.boxShadow = ''; }, 300);
            } else {
                targetKey.style.boxShadow = `0 0 20px ${glowColor}, inset 0 0 12px rgba(255, 255, 255, 0.25)`;
                setTimeout(() => { targetKey.style.boxShadow = ''; }, 200);
            }
        }

        function showGameMessage(text) {
            const message = document.getElementById('message');
            message.textContent = text;
            message.classList.remove('show');
            void message.offsetWidth;
            message.classList.add('show');
        }

        function updateGameNotes() {
            if (!isPlaying) return;
            
            const currentTime = Date.now() - gameStartTime;
            const speed = currentSong?.speed || 1.0;
            const containerHeight = document.querySelector('.track-container').offsetHeight;
            const keyLineY = containerHeight - 80;
            const noteSpeed = 0.35 * speed;
            
            const notes = Array.isArray(currentSong?.notes) ? currentSong.notes : [];
            const trackContainer = document.getElementById('trackContainer');
            
            // Ê∏ÖÈô§ÊóßÈü≥Á¨¶
            document.querySelectorAll('.note').forEach(n => n.remove());
            
            let hasActiveNotes = false;
            let lastNoteTime = 0;
            
            notes.forEach((note, noteIndex) => {
                // Ë∑≥ËøáÂ∑≤Ê∂àÈô§ÁöÑÈü≥Á¨¶
                if (eliminatedNotes.has(noteIndex)) return;
                
                const timeDiff = Math.abs(currentTime - note.time / speed);
                const y = keyLineY - (note.time / speed - currentTime) * noteSpeed;
                
                if (y > -50 && y < containerHeight + 50) {
                    hasActiveNotes = true;
                    
                    // ÂàõÂª∫Èü≥Á¨¶ÂÖÉÁ¥†
                    const noteEl = document.createElement('div');
                    noteEl.className = `note track${note.track}`;
                    noteEl.style.top = y + 'px';
                    noteEl.style.height = '55px';
                    noteEl.innerHTML = `${noteNames[note.track]}<br><small>${(note.duration || 400)}ms</small>`;
                    noteEl.dataset.noteIndex = noteIndex;
                    
                    // Áªü‰∏Ä‰∏∫ÊôÆÈÄöÊñπÂùóÊ†∑Âºè
                    noteEl.style.borderRadius = '12px';
                    noteEl.style.background = `linear-gradient(135deg, ${getTrackColor(note.track)}, ${getTrackColor(note.track, 0.7)})`;
                    
                    if (note.track < 7) {
                        const track = trackContainer.children[note.track];
                        if (track) {
                            track.appendChild(noteEl);
                        }
                    }
                }
                
                // ËÆ∞ÂΩïÊúÄÂêé‰∏Ä‰∏™Èü≥Á¨¶ÁöÑÊó∂Èó¥
                if (note.time > lastNoteTime) {
                    lastNoteTime = note.time;
                }
            });
            
            animationId = requestAnimationFrame(updateGameNotes);
            
            // Ê£ÄÊü•ÊòØÂê¶ÊâÄÊúâÈü≥Á¨¶ÈÉΩÂ∑≤Êí≠ÊîæÂÆåÊØï
            const totalSongTime = lastNoteTime / speed + 3000; // Â¢ûÂä†3ÁßíÁºìÂÜ≤
            if (currentTime > totalSongTime && !hasActiveNotes) {
                setTimeout(() => {
                    if (isPlaying && !hasActiveNotes) {
                        endGame();
                    }
                }, 1000); // È¢ùÂ§ñÁ≠âÂæÖ1ÁßíÁ°Æ‰øùÊ≤°ÊúâÈü≥Á¨¶
            }
        }

        // Ëé∑ÂèñËΩ®ÈÅìÈ¢úËâ≤
        function getTrackColor(track, alpha = 1) {
            const colors = [
                `rgba(255, 107, 107, ${alpha})`,   // track 0
                `rgba(78, 205, 196, ${alpha})`,    // track 1
                `rgba(255, 230, 109, ${alpha})`,   // track 2
                `rgba(162, 155, 254, ${alpha})`,   // track 3
                `rgba(253, 121, 168, ${alpha})`,   // track 4
                `rgba(116, 185, 255, ${alpha})`,   // track 5
                `rgba(85, 239, 196, ${alpha})`     // track 6
            ];
            return colors[track % colors.length];
        }

        // Êõ¥Êñ∞ÊªëÂùóÁä∂ÊÄÅ
        function updateSliderStates(currentTime, speed) {
            const notes = Array.isArray(currentSong?.notes) ? currentSong.notes : [];
            
            sliderStates.forEach((state, track) => {
                if (state.isHolding) {
                    const note = notes[state.noteIndex];
                    if (note) {
                        const elapsedTime = currentTime - state.startTime;
                        const totalDuration = note.duration / speed;
                        const progress = Math.min((elapsedTime / totalDuration) * 100, 100);
                        
                        // Êõ¥Êñ∞ËøõÂ∫¶Êù°
                        const noteElements = document.querySelectorAll(`.note.track${track}.slider-note`);
                        noteElements.forEach(el => {
                            const progressBar = el.querySelector('.slider-progress');
                            if (progressBar) {
                                progressBar.style.width = progress + '%';
                            }
                        });
                        
                        // ÊªëÂùóÂÆåÊàê
                        if (progress >= 100) {
                            completeSlider(track, state.noteIndex);
                        }
                    }
                }
            });
        }

        // ÂÆåÊàêÊªëÂùó
        function completeSlider(track, noteIndex) {
            const state = sliderStates.get(track);
            
            // ÂÅúÊ≠¢Èü≥Êïà
            if (state.audioNode) {
                const { oscillator, gainNode } = state.audioNode;
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                oscillator.stop(audioContext.currentTime + 0.2);
            }
            
            // Ê†áËÆ∞‰∏∫ÂÆåÊàê
            sliderStates.set(track, {
                ...state,
                isHolding: false
            });
            
            // Â¢ûÂä†ÂàÜÊï∞
            score += 200;
            combo++;
            document.getElementById('score').textContent = score;
            document.getElementById('combo').textContent = combo;
            showGameMessage('ÊªëÂùóÂÆåÊàê! üéâ');
            
            // ÁßªÈô§ÊªëÂùóÂÖÉÁ¥†
            const noteElements = document.querySelectorAll(`.note.track${track}.slider-note`);
            noteElements.forEach(el => {
                el.classList.remove('holding');
                el.classList.add('hit');
                setTimeout(() => el.remove(), 300);
            });
        }

        async function endGame() {
            isPlaying = false;
            cancelAnimationFrame(animationId);
            
            // ‰øùÂ≠òÁî®Êà∑ÂàÜÊï∞
            if (currentUser && currentSong) {
                try {
                    // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÊúâÂàÜÊï∞
                    const { data: existingScore } = await supabaseClient
                        .from('scores')
                        .select('score')
                        .eq('user_id', currentUser.id)
                        .eq('song_id', currentSong.id)
                        .single();
                    
                    if (existingScore) {
                        // Êõ¥Êñ∞ÊúÄÈ´òÂàÜ
                        if (score > existingScore.score) {
                            await supabaseClient
                                .from('scores')
                                .update({ score: score })
                                .eq('user_id', currentUser.id)
                                .eq('song_id', currentSong.id);
                            
                            // Êõ¥Êñ∞Áî®Êà∑ÊÄªÂàÜ
                            const scoreDiff = score - existingScore.score;
                            await supabaseClient
                                .from('users')
                                .update({ total_score: (currentUser.total_score || 0) + scoreDiff })
                                .eq('id', currentUser.id);
                            
                            // Êõ¥Êñ∞ÂΩìÂâçÁî®Êà∑ÂØπË±°
                            currentUser.total_score = (currentUser.total_score || 0) + scoreDiff;
                        }
                    } else {
                        // ÊèíÂÖ•Êñ∞ÂàÜÊï∞
                        await supabaseClient
                            .from('scores')
                            .insert({
                                user_id: currentUser.id,
                                song_id: currentSong.id,
                                score: score
                            });
                        
                        // Êõ¥Êñ∞Áî®Êà∑ÊÄªÂàÜ
                        await supabaseClient
                            .from('users')
                            .update({ total_score: (currentUser.total_score || 0) + score })
                            .eq('id', currentUser.id);
                        
                        // Êõ¥Êñ∞ÂΩìÂâçÁî®Êà∑ÂØπË±°
                        currentUser.total_score = (currentUser.total_score || 0) + score;
                    }
                } catch (err) {
                    console.error('‰øùÂ≠òÂàÜÊï∞Â§±Ë¥•:', err);
                }
            }
            
            // Á´ãÂç≥ÊòæÁ§∫ÁªìÁÆóÁïåÈù¢
            document.getElementById('finalScoreValue').textContent = score;
            document.getElementById('finalScore').style.display = 'block';
            document.getElementById('gameStartBtn').style.display = 'none';
            document.getElementById('startOverlay').style.display = 'flex';
            
            // Ê∏ÖÈô§ÊâÄÊúâÈü≥Á¨¶
            document.querySelectorAll('.note').forEach(n => n.remove());
            
            // ÊòæÁ§∫Ê∏∏ÊàèÁªìÊùüÊèêÁ§∫
            showGameMessage('Ê∏∏ÊàèÁªìÊùü! üéâ');
        }

        let noteDuration = 400; // ÈªòËÆ§Èü≥Á¨¶ÈïøÂ∫¶
        let isDeleteMode = false; // Âà†Èô§Ê®°ÂºèÁä∂ÊÄÅ
        let volumeLevel = 0.8; // ÈªòËÆ§Èü≥ÈáèÔºà0-1Ôºâ
        let currentOctave = 1; // ÈªòËÆ§ÂÖ´Â∫¶Ôºà0=‰ΩéÂÖ´Â∫¶Ôºå1=‰∏≠ÂÖ´Â∫¶Ôºå2=È´òÂÖ´Â∫¶Ôºâ
        let backgroundMusic = null; // ËÉåÊôØÈü≥‰πêÂØπË±°
        let isBackgroundMusicPlaying = true; // ËÉåÊôØÈü≥‰πêÊí≠ÊîæÁä∂ÊÄÅ
        let backgroundMusicVolume = 0.3; // ËÉåÊôØÈü≥‰πêÈü≥ÈáèÔºà0-1Ôºâ
        
        function addNote(track, duration = noteDuration) {
            if (audioContext.state === 'suspended') audioContext.resume();
            
            let time = 0;
            if (editorNotes.length > 0) {
                const lastNote = editorNotes[editorNotes.length - 1];
                time = lastNote.time + lastNote.duration;
            }
            
            editorNotes.push({
                track: track,
                time: time,
                duration: duration,
                octave: currentOctave
            });
            
            // ËÆ°ÁÆóÂ∏¶ÂÖ´Â∫¶ÁöÑÈ¢ëÁéá
            const octaveMultiplier = Math.pow(2, currentOctave - 1);
            const freq = noteFreqs[track] * octaveMultiplier;
            playTone(freq, duration / 1000, 0.4);
            renderEditorNotes();
        }

        function renderEditorNotes() {
            document.querySelectorAll('.editor-note').forEach(n => n.remove());
            
            const tracks = document.querySelectorAll('.editor-track');
            
            // ËÆ°ÁÆóÈúÄË¶ÅÁöÑÊúÄÂ∞èÈ´òÂ∫¶
            let maxTime = 0;
            editorNotes.forEach(note => {
                const noteEndTime = note.time + (note.duration || 400);
                if (noteEndTime > maxTime) {
                    maxTime = noteEndTime;
                }
            });
            
            // ËΩ¨Êç¢‰∏∫ÂÉèÁ¥†È´òÂ∫¶ÔºåÂπ∂Â¢ûÂä†È¢ùÂ§ñÁºìÂÜ≤Á©∫Èó¥
            const minRequiredHeight = Math.max(400, (maxTime / 10) + 300); // Âü∫Á°Ä400px + Èü≥Á¨¶ÁªìÊùü‰ΩçÁΩÆ + 300pxÁºìÂÜ≤
            
            // Êõ¥Êñ∞ÊØè‰∏™ËΩ®ÈÅìÁöÑÈ´òÂ∫¶
            tracks.forEach(track => {
                track.style.height = minRequiredHeight + 'px';
            });
            
            // ÂêåÊó∂Êõ¥Êñ∞editor-tracksÂÆπÂô®ÁöÑÈ´òÂ∫¶
            const editorTracksEl = document.getElementById('editorTracks');
            if (editorTracksEl) {
                editorTracksEl.style.minHeight = minRequiredHeight + 'px';
            }
            
            editorNotes.forEach((note, index) => {
                const noteEl = document.createElement('div');
                noteEl.className = `editor-note track${note.track}`;
                noteEl.dataset.index = index;
                noteEl.style.top = (note.time / 10) + 'px';
                // Âõ∫ÂÆöÊñπÂùóÊòæÁ§∫Â§ßÂ∞èÔºå‰∏çÈöèÈïøÂ∫¶ÂèòÂåñ
                noteEl.style.height = '45px';
                // Âú®ÊñπÂùó‰∏≠Ê†áÊòéÈïøÂ∫¶ÂíåÂÖ´Â∫¶
                const octaveText = note.octave === 0 ? '‰Ωé' : (note.octave === 1 ? '‰∏≠' : 'È´ò');
                noteEl.innerHTML = `${noteNames[note.track]}<br><small>${note.duration}ms | ${octaveText}ÂÖ´Â∫¶</small>`;
                noteEl.title = `ÂèåÂáªÂà†Èô§ | ÈïøÂ∫¶: ${note.duration}ms | ÂÖ´Â∫¶: ${octaveText} | Êó∂Èó¥: ${note.time}ms`;
                noteEl.draggable = true;
                
                // ÂèåÂáªÂà†Èô§
                noteEl.addEventListener('dblclick', function(e) {
                    e.stopPropagation();
                    editorNotes.splice(index, 1);
                    renderEditorNotes();
                    showToast('Â∑≤Âà†Èô§Èü≥Á¨¶');
                });
                
                // ÊãñÊãΩÂäüËÉΩ
                let isDragging = false;
                let startY = 0;
                let startTop = 0;
                
                noteEl.addEventListener('mousedown', function(e) {
                    e.stopPropagation();
                    
                    // Â¶ÇÊûúÂú®Âà†Èô§Ê®°Âºè‰∏ãÔºåÁõ¥Êé•Âà†Èô§Èü≥Á¨¶
                    if (isDeleteMode) {
                        editorNotes.splice(index, 1);
                        renderEditorNotes();
                        showToast('Â∑≤Âà†Èô§Èü≥Á¨¶');
                        return;
                    }
                    
                    isDragging = true;
                    startY = e.clientY;
                    startTop = parseInt(noteEl.style.top) || 0;
                    noteEl.style.cursor = 'grabbing';
                    noteEl.style.opacity = '0.8';
                });
                
                // ÁÇπÂáª‰∫ã‰ª∂ÔºàÁî®‰∫éËß¶Êë∏ËÆæÂ§áÔºâ
                noteEl.addEventListener('click', function(e) {
                    e.stopPropagation();
                    
                    // Â¶ÇÊûúÂú®Âà†Èô§Ê®°Âºè‰∏ãÔºåÂà†Èô§Èü≥Á¨¶
                    if (isDeleteMode) {
                        editorNotes.splice(index, 1);
                        renderEditorNotes();
                        showToast('Â∑≤Âà†Èô§Èü≥Á¨¶');
                    }
                });
                
                document.addEventListener('mousemove', function(e) {
                    if (!isDragging) return;
                    
                    const deltaY = e.clientY - startY;
                    const newTop = Math.max(0, startTop + deltaY);
                    noteEl.style.top = newTop + 'px';
                });
                
                document.addEventListener('mouseup', function() {
                    if (!isDragging) return;
                    
                    isDragging = false;
                    noteEl.style.cursor = 'grab';
                    noteEl.style.opacity = '1';
                    
                    // Êõ¥Êñ∞Èü≥Á¨¶Êó∂Èó¥
                    const newTop = parseInt(noteEl.style.top) || 0;
                    const newTime = Math.max(0, Math.round(newTop * 10));
                    
                    if (newTime !== note.time) {
                        note.time = newTime;
                        editorNotes.sort((a, b) => a.time - b.time);
                        renderEditorNotes();
                        showToast(`Èü≥Á¨¶Êó∂Èó¥Â∑≤Ë∞ÉÊï¥‰∏∫: ${newTime}ms`);
                    }
                });
                
                // Ëß¶Êë∏ËÆæÂ§áÊîØÊåÅ
                noteEl.addEventListener('touchstart', function(e) {
                    e.stopPropagation();
                    
                    // Â¶ÇÊûúÂú®Âà†Èô§Ê®°Âºè‰∏ãÔºåÁõ¥Êé•Âà†Èô§Èü≥Á¨¶
                    if (isDeleteMode) {
                        editorNotes.splice(index, 1);
                        renderEditorNotes();
                        showToast('Â∑≤Âà†Èô§Èü≥Á¨¶');
                        return;
                    }
                    
                    isDragging = true;
                    startY = e.touches[0].clientY;
                    startTop = parseInt(noteEl.style.top) || 0;
                    noteEl.style.cursor = 'grabbing';
                    noteEl.style.opacity = '0.8';
                }, {passive: false});
                
                document.addEventListener('touchmove', function(e) {
                    if (!isDragging) return;
                    
                    const deltaY = e.touches[0].clientY - startY;
                    const newTop = Math.max(0, startTop + deltaY);
                    noteEl.style.top = newTop + 'px';
                }, {passive: false});
                
                document.addEventListener('touchend', function() {
                    if (!isDragging) return;
                    
                    isDragging = false;
                    noteEl.style.cursor = 'grab';
                    noteEl.style.opacity = '1';
                    
                    // Êõ¥Êñ∞Èü≥Á¨¶Êó∂Èó¥
                    const newTop = parseInt(noteEl.style.top) || 0;
                    const newTime = Math.max(0, Math.round(newTop * 10));
                    
                    if (newTime !== note.time) {
                        note.time = newTime;
                        editorNotes.sort((a, b) => a.time - b.time);
                        renderEditorNotes();
                        showToast(`Èü≥Á¨¶Êó∂Èó¥Â∑≤Ë∞ÉÊï¥‰∏∫: ${newTime}ms`);
                    }
                });
                
                if (note.track < tracks.length) {
                    tracks[note.track].appendChild(noteEl);
                }
            });
            
            document.getElementById('editorTip').style.display = editorNotes.length === 0 ? 'block' : 'none';
        }

        function playEditorPreview() {
            if (editorNotes.length === 0) {
                showToast('ËØ∑ÂÖàÊ∑ªÂä†Èü≥Á¨¶');
                return;
            }
            
            if (audioContext.state === 'suspended') audioContext.resume();
            
            const sortedNotes = [...editorNotes].sort((a, b) => a.time - b.time);
            
            sortedNotes.forEach(note => {
                setTimeout(() => {
                    // ËÆ°ÁÆóÂ∏¶ÂÖ´Â∫¶ÁöÑÈ¢ëÁéá
                    const octaveMultiplier = Math.pow(2, (note.octave || 1) - 1);
                    const freq = noteFreqs[note.track] * octaveMultiplier;
                    playTone(freq, note.duration / 1000, 0.4);
                }, note.time);
            });
            
            showToast('Êí≠ÊîæÈ¢ÑËßà‰∏≠...');
        }

        document.getElementById('startBtn')?.addEventListener('click', function() {
            startGame();
            return false;
        });

        function startGame() {
            if (audioContext.state === 'suspended') {
                audioContext.resume().then(() => {
                    console.log('Èü≥È¢ë‰∏ä‰∏ãÊñáÂ∑≤ÊÅ¢Â§ç');
                    if (isBackgroundMusicPlaying) {
                        playBackgroundMusic();
                    }
                });
            }
            
            if (!supabaseClient) {
                const initialized = initSupabase();
                if (!initialized) {
                    showToast('SupabaseÂàùÂßãÂåñÂ§±Ë¥•ÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï');
                }
            }
            
            document.getElementById('splashScreen').style.display = 'none';
            document.getElementById('authScreen').classList.add('active');
        }

        // ÊªëÂä®Ëß£ÈîÅÂäüËÉΩ
        function initSlideUnlock() {
            const slideUnlock = document.getElementById('slideUnlock');
            const slideThumb = document.getElementById('slideThumb');
            const slideText = document.getElementById('slideText');
            const slideSuccess = document.getElementById('slideSuccess');
            
            if (!slideUnlock) return;
            
            let isSliding = false;
            let startX = 0;
            let currentX = 0;
            const maxSlide = slideUnlock.offsetWidth - slideThumb.offsetWidth - 6;
            
            function handleStart(e) {
                e.preventDefault();
                isSliding = true;
                startX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
                slideThumb.classList.add('pressed');
                slideText.classList.add('sliding');
            }
            
            function handleMove(e) {
                if (!isSliding) return;
                e.preventDefault();
                
                const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
                currentX = clientX - startX;
                
                if (currentX < 0) currentX = 0;
                if (currentX > maxSlide) currentX = maxSlide;
                
                slideThumb.style.left = (currentX + 3) + 'px';
            }
            
            function handleEnd() {
                if (!isSliding) return;
                isSliding = false;
                slideThumb.classList.remove('pressed');
                
                if (currentX >= maxSlide * 0.9) {
                    slideThumb.style.left = (maxSlide + 3) + 'px';
                    slideSuccess.classList.add('show');
                    slideText.classList.remove('sliding');
                    
                    setTimeout(() => {
                        startGame();
                    }, 300);
                } else {
                    slideThumb.style.left = '3px';
                    slideText.classList.remove('sliding');
                }
                
                currentX = 0;
            }
            
            slideUnlock.addEventListener('mousedown', handleStart);
            slideUnlock.addEventListener('touchstart', handleStart, { passive: false });
            
            document.addEventListener('mousemove', handleMove);
            document.addEventListener('touchmove', handleMove, { passive: false });
            
            document.addEventListener('mouseup', handleEnd);
            document.addEventListener('touchend', handleEnd);
        }

        initSlideUnlock();

        // ÁôªÂΩïÊ≥®ÂÜåÂàáÊç¢
        document.getElementById('authToggleText').addEventListener('click', function() {
            isAuthModeLogin = !isAuthModeLogin;
            document.getElementById('authTitle').textContent = isAuthModeLogin ? 'ÁôªÂΩï' : 'Ê≥®ÂÜå';
            document.getElementById('authSubmitBtn').textContent = isAuthModeLogin ? 'ÁôªÂΩï' : 'Ê≥®ÂÜå';
            document.getElementById('authToggleText').textContent = isAuthModeLogin ? 'Ê≤°ÊúâË¥¶Âè∑ÔºüÁÇπÂáªÊ≥®ÂÜå' : 'Â∑≤ÊúâË¥¶Âè∑ÔºüÁÇπÂáªÁôªÂΩï';
        });

        // ÁôªÂΩïÊ≥®ÂÜåÊèê‰∫§
        document.getElementById('authSubmitBtn').addEventListener('click', async function() {
            const id = document.getElementById('authId').value.trim();
            const password = document.getElementById('authPassword').value;
            
            if (!id || !password) {
                showToast('ËØ∑ËæìÂÖ•IDÂíåÂØÜÁ†Å');
                return;
            }
            
            try {
                if (isAuthModeLogin) {
                    // ÁôªÂΩïÈÄªËæë
                    const { data, error } = await supabaseClient
                        .from('users')
                        .select('*')
                        .eq('id', id)
                        .eq('password', password)
                        .single();
                    
                    if (error || !data) {
                        showToast('ÁôªÂΩïÂ§±Ë¥•ÔºåIDÊàñÂØÜÁ†ÅÈîôËØØ');
                        return;
                    }
                    
                    currentUser = data;
                    showToast('ÁôªÂΩïÊàêÂäüÔºÅ');
                    
                    // Ê£ÄÊü•ÊòØÂê¶‰∏∫ÁÆ°ÁêÜÂëò
                    if (data.is_admin) {
                        document.getElementById('adminBtn').style.display = 'block';
                    } else {
                        document.getElementById('adminBtn').style.display = 'none';
                    }
                } else {
                    // Ê≥®ÂÜåÈÄªËæë
                    const { data, error } = await supabaseClient
                        .from('users')
                        .select('*')
                        .eq('id', id)
                        .single();
                    
                    if (data) {
                        showToast('Ê≥®ÂÜåÂ§±Ë¥•ÔºåIDÂ∑≤Â≠òÂú®');
                        return;
                    }
                    
                    const { data: newUser, error: createError } = await supabaseClient
                        .from('users')
                        .insert({
                            id: id,
                            password: password,
                            total_score: 0
                        })
                        .select()
                        .single();
                    
                    if (createError) {
                        showToast('Ê≥®ÂÜåÂ§±Ë¥•Ôºö' + createError.message);
                        return;
                    }
                    
                    currentUser = newUser;
                    showToast('Ê≥®ÂÜåÊàêÂäüÔºÅ');
                }
                
                // ÁôªÂΩïÊàêÂäüÂêéËøõÂÖ•Ê∏∏Êàè
                document.getElementById('authScreen').classList.remove('active');
                document.getElementById('gameHeader').style.display = 'flex';
                document.getElementById('userInfo').textContent = currentUser.id;
                showScreen('lobby');
                loadSongs();
            } catch (err) {
                showToast('Êìç‰ΩúÂ§±Ë¥•Ôºö' + err.message);
            }
        });

        // ÊéíË°åÊ¶úÊåâÈíÆÁÇπÂáª
        document.getElementById('leaderboardBtn').addEventListener('click', function() {
            if (!currentUser) {
                showToast('ËØ∑ÂÖàÁôªÂΩï');
                return;
            }
            showLeaderboard();
            return false;
        });

        // ÂÖ≥Èó≠ÊéíË°åÊ¶ú
        document.getElementById('leaderboardClose').addEventListener('click', function() {
            document.getElementById('leaderboardDialog').classList.remove('show');
            return false;
        });

        // Èü≥‰πêÊåâÈíÆÁÇπÂáª
        document.getElementById('musicBtn').addEventListener('click', function() {
            toggleBackgroundMusic();
            return false;
        });

        // Èü≥ÊïàÊåâÈíÆÁÇπÂáª
        document.getElementById('sfxBtn').addEventListener('click', function() {
            soundEffectsEnabled = !soundEffectsEnabled;
            updateSfxButton();
            return false;
        });

        // ÂÆ°Ê†∏ÊåâÈíÆÁÇπÂáª
        document.getElementById('adminBtn').addEventListener('click', function() {
            showAdminPanel();
            return false;
        });

        // ÂÖ≥Èó≠ÂÆ°Ê†∏Èù¢Êùø
        document.getElementById('adminClose').addEventListener('click', function() {
            document.getElementById('adminDialog').classList.remove('show');
            return false;
        });

        // Â∞ÅÈù¢Èü≥‰πêÊåâÈíÆÁÇπÂáª
        document.getElementById('splashMusicBtn').addEventListener('click', function() {
            toggleBackgroundMusic();
            return false;
        });

        // ÁôªÂΩïÈ°µÈü≥‰πêÊåâÈíÆÁÇπÂáª
        document.getElementById('authMusicBtn').addEventListener('click', function() {
            toggleBackgroundMusic();
            return false;
        });

        document.getElementById('createBtn').addEventListener('click', function() {
            editorNotes = [];
            document.getElementById('songTitle').value = '';
            document.getElementById('songSpeed').value = '1.0';
            renderEditorNotes();
            showScreen('editor');
        });

        document.getElementById('backBtn').addEventListener('click', function() {
            showConfirm('ËøîÂõûÂ∞Ü‰∏¢Â§±Êú™‰øùÂ≠òÁöÑÂÜÖÂÆπÔºåÁ°ÆÂÆöËøîÂõû?', () => {
                showScreen('lobby');
            });
        });

        document.getElementById('gameBackBtn').addEventListener('click', function() {
            isPlaying = false;
            cancelAnimationFrame(animationId);
            showScreen('lobby');
        });

        document.getElementById('clearBtn').addEventListener('click', function() {
            showConfirm('Á°ÆÂÆöÊ∏ÖÁ©∫ÊâÄÊúâÈü≥Á¨¶?', () => {
                editorNotes = [];
                renderEditorNotes();
                showToast('Â∑≤Ê∏ÖÁ©∫');
            });
        });

        document.getElementById('previewBtn').addEventListener('click', function() {
            playEditorPreview();
        });

        document.getElementById('saveBtn').addEventListener('click', async function() {
            const title = document.getElementById('songTitle').value.trim();
            const speed = parseFloat(document.getElementById('songSpeed').value) || 1.0;
            
            if (!title) {
                showToast('ËØ∑ËæìÂÖ•Ê≠åÊõ≤ÂêçÁß∞');
                return;
            }
            
            if (editorNotes.length === 0) {
                showToast('ËØ∑ÂÖàÊ∑ªÂä†Èü≥Á¨¶');
                return;
            }
            
            if (!supabaseClient) {
                showToast('SupabaseÊú™ÂàùÂßãÂåñÔºåÊó†Ê≥ï‰øùÂ≠ò');
                return;
            }
            
            showConfirm('Á°ÆÂÆöÂèëÂ∏ÉËøôÈ¶ñÊ≠åÊõ≤?', async () => {
                const notesData = editorNotes.map(n => {
                    // ËÆ°ÁÆóÂ∏¶ÂÖ´Â∫¶ÁöÑÈ¢ëÁéá
                    const octaveMultiplier = Math.pow(2, (n.octave || 1) - 1);
                    const freq = noteFreqs[n.track] * octaveMultiplier;
                    return {
                        track: n.track,
                        time: n.time,
                        duration: n.duration || 400,
                        octave: n.octave || 1,
                        freq: freq
                    };
                });
                
                try {
                    console.log('‰øùÂ≠òÊ≠åÊõ≤Êï∞ÊçÆ:', {
                        title: title,
                        author: currentUser ? currentUser.id : 'ÂåøÂêçÁé©ÂÆ∂',
                        notes: notesData,
                        speed: speed
                    });
                    
                    const { error } = await supabaseClient.from('songs').insert({
                        title: title,
                        author: currentUser ? currentUser.id : 'ÂåøÂêçÁé©ÂÆ∂',
                        notes: notesData,
                        speed: speed,
                        play_count: 0,
                        like_count: 0,
                        status: 'pending'
                    });
                    
                    if (error) {
                        console.error('‰øùÂ≠òÊ≠åÊõ≤Â§±Ë¥•:', error);
                        throw error;
                    }
                    
                    showToast('Êèê‰∫§ÊàêÂäüÔºåÁ≠âÂæÖÂÆ°Ê†∏!');
                    await loadSongs();
                    showScreen('lobby');
                } catch (err) {
                    console.error('‰øùÂ≠òÂ§±Ë¥•:', err);
                    showToast('‰øùÂ≠òÂ§±Ë¥•: ' + err.message);
                }
            });
        });

        document.getElementById('gameStartBtn').addEventListener('click', function() {
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
            score = 0;
            combo = 0;
            eliminatedNotes = new Set(); // ÈáçÁΩÆÂ∑≤Ê∂àÈô§ÁöÑÈü≥Á¨¶
            comboEffectShown = { 20: false, 40: false }; // ÈáçÁΩÆËøûÂáªÁâπÊïàÊ†áÂøó
            document.getElementById('score').textContent = 0;
            document.getElementById('combo').textContent = 0;
            
            isPlaying = true;
            document.getElementById('startOverlay').style.display = 'none';
            
            // Â∞ùËØïÈîÅÂÆö‰∏∫Ê®™Â±è
            if (screen.orientation && screen.orientation.lock) {
                screen.orientation.lock('landscape').catch(() => {});
            }
            
            gameStartTime = Date.now();
            
            // Ê∏ÖÈô§ÊóßÈü≥Á¨¶
            document.querySelectorAll('.note').forEach(n => n.remove());
            
            // ÂºÄÂßãÊ∏∏ÊàèÂæ™ÁéØ
            updateGameNotes();
        });

        document.querySelectorAll('.editor-key').forEach(key => {
            key.addEventListener('click', function(e) {
                e.preventDefault();
                const track = parseInt(this.dataset.track);
                addNote(track);
                return false;
            });
            
            key.addEventListener('touchstart', function(e) {
                e.preventDefault();
                const track = parseInt(this.dataset.track);
                addNote(track);
                return false;
            }, {passive: false});
        });

        document.querySelectorAll('.editor-track').forEach(track => {
            track.addEventListener('click', function(e) {
                const trackIndex = parseInt(this.dataset.track);
                const rect = this.getBoundingClientRect();
                const clickY = e.clientY - rect.top;
                
                // ËÆ°ÁÆóÁÇπÂáª‰ΩçÁΩÆÂØπÂ∫îÁöÑÊó∂Èó¥Ôºà10px = 100msÔºâ
                const time = Math.max(0, Math.round(clickY * 10));
                
                // ÂàõÂª∫Êñ∞Èü≥Á¨¶
                const newNote = {
                    track: trackIndex,
                    time: time,
                    duration: noteDuration,
                    octave: currentOctave
                };
                
                // Ê∑ªÂä†Âà∞Êï∞ÁªÑÂπ∂ÊåâÊó∂Èó¥ÊéíÂ∫è
                editorNotes.push(newNote);
                editorNotes.sort((a, b) => a.time - b.time);
                
                // Êí≠ÊîæÈü≥ÊïàÂπ∂ÈáçÊñ∞Ê∏≤Êüì
                if (audioContext.state === 'suspended') audioContext.resume();
                playTone(noteFreqs[trackIndex], noteDuration / 1000, 0.4);
                renderEditorNotes();
                showToast(`Â∑≤Ê∑ªÂä†Èü≥Á¨¶Âà∞Êó∂Èó¥: ${time}ms`);
                return false;
            });
        });

        // Èü≥ËäÇÈïøÂ∫¶ÊéßÂà∂ÊåâÈíÆ‰∫ã‰ª∂
        document.querySelectorAll('.duration-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.duration-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                noteDuration = parseInt(this.dataset.duration);
                showToast(`Èü≥Á¨¶ÈïøÂ∫¶Â∑≤ËÆæÁΩÆ‰∏∫: ${noteDuration}ms`);
            });
        });

        // Âà†Èô§Ê®°ÂºèÊåâÈíÆ‰∫ã‰ª∂
        document.getElementById('deleteBtn').addEventListener('click', function() {
            isDeleteMode = !isDeleteMode;
            if (isDeleteMode) {
                this.classList.add('active');
                this.style.background = '#e74c3c';
                this.textContent = 'ÂèñÊ∂àÂà†Èô§';
                showToast('Â∑≤ËøõÂÖ•Âà†Èô§Ê®°ÂºèÔºåÁÇπÂáªÈü≥Á¨¶Âç≥ÂèØÂà†Èô§');
            } else {
                this.classList.remove('active');
                this.style.background = '';
                this.textContent = 'Âà†Èô§Ê®°Âºè';
                showToast('Â∑≤ÈÄÄÂá∫Âà†Èô§Ê®°Âºè');
            }
        });

        // Ëá™ÂÆö‰πâÈïøÂ∫¶ËÆæÁΩÆÊåâÈíÆ‰∫ã‰ª∂
        document.getElementById('setDurationBtn').addEventListener('click', function() {
            const customDuration = parseInt(document.getElementById('customDuration').value);
            if (customDuration && customDuration >= 100 && customDuration <= 5000) {
                noteDuration = customDuration;
                document.querySelectorAll('.duration-btn').forEach(btn => btn.classList.remove('active'));
                showToast(`Èü≥Á¨¶ÈïøÂ∫¶Â∑≤ËÆæÁΩÆ‰∏∫: ${customDuration}ms`);
            } else {
                showToast('ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÈïøÂ∫¶ (100-5000ms)');
            }
        });

        // Ëá™ÂÆö‰πâÈïøÂ∫¶ËæìÂÖ•Ê°ÜÂõûËΩ¶‰∫ã‰ª∂
        document.getElementById('customDuration').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('setDurationBtn').click();
            }
        });

        // ÂÖ´Â∫¶ÈÄâÊã©‰∫ã‰ª∂
        document.getElementById('octaveSelect').addEventListener('change', function() {
            currentOctave = parseInt(this.value);
            const octaveText = currentOctave === 0 ? '‰ΩéÂÖ´Â∫¶' : (currentOctave === 1 ? '‰∏≠ÂÖ´Â∫¶' : 'È´òÂÖ´Â∫¶');
            showToast(`Â∑≤ÂàáÊç¢Âà∞${octaveText}`);
        });

        // Á©∫Ê†ºÈîÆÊ∑ªÂä†Èü≥Á¨¶ÊîØÊåÅ
        document.addEventListener('keydown', function(e) {
            if (currentScreen === 'editor' && e.code === 'Space') {
                e.preventDefault();
                // ÈªòËÆ§Ê∑ªÂä†Âà∞‰∏≠Èó¥ËΩ®ÈÅìÔºà3Âè∑ËΩ®ÈÅìÔºâ
                addNote(3);
            }
            return false;
        });

        // Èü≥ÈáèÊéßÂà∂‰∫ã‰ª∂
        document.getElementById('volumeBtn').addEventListener('click', function(e) {
            e.stopPropagation();
            const volumeSlider = document.getElementById('volumeSlider');
            volumeSlider.classList.toggle('show');
            return false;
        });
        
        // Èü≥ÈáèÊªëÂùóÂèòÂåñ‰∫ã‰ª∂
        document.getElementById('volumeRange').addEventListener('input', function() {
            const volume = parseInt(this.value);
            volumeLevel = volume / 100;
            
            document.getElementById('volumeLevel').textContent = volume + '%';
            document.getElementById('volumeLevelDisplay').textContent = volume + '%';
            return false;
        });
        
        // ÁÇπÂáªÂÖ∂‰ªñÂú∞ÊñπÂÖ≥Èó≠Èü≥ÈáèÊªëÂùó
        document.addEventListener('click', function(e) {
            const volumeControl = document.querySelector('.volume-control');
            if (!volumeControl.contains(e.target)) {
                document.getElementById('volumeSlider').classList.remove('show');
            }
            return false;
        });

        document.getElementById('gameHeader').style.display = 'none';
    </script>
</body>
</html>
